function svgify(){jQuery("img.svg").each(function(){var a=jQuery(this),b=a.attr("id"),c=a.attr("class"),d=a.attr("src");jQuery.get(d,function(d){var e=jQuery(d).find("svg");"undefined"!=typeof b&&(e=e.attr("id",b)),"undefined"!=typeof c&&(e=e.attr("class",c+" replaced-svg")),e=e.removeAttr("xmlns:a"),a.replaceWith(e)},"xml")})}function applyTicks(a){"intro"==a||"add"==a?($("span.glyphicon.add").addClass("hidden"),$("span.glyphicon.map").addClass("hidden"),$("span.glyphicon.validate").addClass("hidden")):"validate"==a?($("span.glyphicon.add").removeClass("hidden"),$("span.glyphicon.validate").addClass("hidden"),$("span.glyphicon.map").addClass("hidden")):"map"==a?($("span.glyphicon.add").removeClass("hidden"),$("span.glyphicon.validate").removeClass("hidden"),$("span.glyphicon.map").addClass("hidden")):"finish"==a&&($("span.glyphicon.add").removeClass("hidden"),$("span.glyphicon.map").removeClass("hidden"),$("span.glyphicon.validate").removeClass("hidden"))}function splitInput(a){var b=[],c=/\r\n|\n\r|\n|\r/g,d=a.replace(c,"\n").split("\n");if(1==d.length&&""==d[0].trim())return!1;d=$.map(d,$.trim),d.clean(""),d.clean(void 0);var e=!0,f="";return jQuery.each(d,function(a,c){var d=smilesOrInchi(c);0==a&&(f=d),d!=f&&(e=!1),b.push(c.trim())}),e?{type:f,objects:b}:!1}function smilesOrInchi(a){var b="";return b=a.trim().match(/^([^J][A-Za-z0-9@+\-\[\]\(\)\\=#$.]+)$/)?"Smiles":a.trim().match(/^((InChI=)?[^J][0-9BCOHNSOPrIFla+\-\(\)\\\/,pqbtmsih]{6,})$/gi)?"InChi":a.trim().match(/^((CHEMBL)?[0-9])$/)?"ChEMBL ID":"unknown"}function prepCustomFields(a){var b={};a.map(function(a){a.name&&a.value&&(b[a.name]=a.value)});return b}function detectIE(){var a=window.navigator.userAgent,b=a.indexOf("MSIE ");if(b>0)return parseInt(a.substring(b+5,a.indexOf(".",b)),10);var c=a.indexOf("Trident/");if(c>0){var d=a.indexOf("rv:");return parseInt(a.substring(d+3,a.indexOf(".",d)),10)}var e=a.indexOf("Edge/");return e>0?parseInt(a.substring(e+5,a.indexOf(".",e)),10):!1}angular.module("schemaForm").run(["$templateCache",function(a){a.put("directives/decorators/bootstrap/array.html",'<div sf-array="form" class="schema-form-array {{form.htmlClass}}" ng-model="$$value$$" ng-model-options="form.ngModelOptions"><label class="control-label" ng-show="showTitle()">{{ form.title }}</label><div class="help-block" ng-show="(hasError() && errorMessage(schemaError())) || form.description" ng-bind-html="(hasError() && errorMessage(schemaError())) || form.description"></div><ol class="list-group" ng-model="modelArray" ui-sortable="draggable"><li style="cursor: move;" class="list-group-item {{form.fieldHtmlClass}}" ng-repeat="item in modelArray track by $index"><button ng-hide="form.readonly || form.remove === null || item.id" ng-click="deleteFromArray($index)" style="position: relative; z-index: 20; font-size:2em; font-weight:bold; opacity:0.5" type="button" class="close pull-right"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button><sf-decorator ng-init="arrayIndex = $index" form="copyWithIndex($index)"></sf-decorator><span class="glyphicon glyphicon-move pull-right "style="color:grey;position: relative; z-index: 20; margin-top:-50px"></span></li></ol><div class="clearfix" style="padding: 15px;"><button ng-hide="form.readonly || form.add === null" ng-click="appendToArray()" type="button" class="btn {{ form.style.add || \'btn-default\' }} pull-right"><i class="glyphicon glyphicon-plus"></i> {{ form.add || \'Add\'}}</button></div></div>'),a.put("directives/decorators/bootstrap/default.html",'<div class="form-group schema-form-{{form.type}} {{form.htmlClass}}" ng-class="{\'has-error\': form.disableErrorState !== true && hasError(), \'has-success\': form.disableSuccessState !== true && hasSuccess(), \'has-feedback\': form.feedback !== false }"><label class="control-label {{form.labelHtmlClass}}" ng-class="{\'sr-only\': !showTitle()}" for="{{form.key.slice(-1)[0]}}">{{form.title}}</label> <input ng-if="!form.fieldAddonLeft && !form.fieldAddonRight" ng-show="form.key" type="{{form.type}}" step="any" sf-changed="form" placeholder="{{form.placeholder}}" class="form-control {{form.fieldHtmlClass}}" id="{{form.key.slice(-1)[0]}}" ng-model-options="form.ngModelOptions" ng-model="$$value$$" ng-disabled="form.readonly ? true : (form.isReadOnly ? form.isReadOnly(form.key) : false)" schema-validate="form" name="{{form.key.slice(-1)[0]}}" aria-describedby="{{form.key.slice(-1)[0] + \'Status\'}}"><div ng-if="form.fieldAddonLeft || form.fieldAddonRight" ng-class="{\'input-group\': (form.fieldAddonLeft || form.fieldAddonRight)}"><span ng-if="form.fieldAddonLeft" class="input-group-addon" ng-bind-html="form.fieldAddonLeft"></span> <input ng-show="form.key" type="{{form.type}}" step="any" sf-changed="form" placeholder="{{form.placeholder}}" class="form-control {{form.fieldHtmlClass}}" id="{{form.key.slice(-1)[0]}}" ng-model-options="form.ngModelOptions" ng-model="$$value$$" ng-disabled="form.readonly" schema-validate="form" name="{{form.key.slice(-1)[0]}}" aria-describedby="{{form.key.slice(-1)[0] + \'Status\'}}"> <span ng-if="form.fieldAddonRight" class="input-group-addon" ng-bind-html="form.fieldAddonRight"></span></div><span ng-if="form.feedback !== false" class="form-control-feedback" ng-class="evalInScope(form.feedback) || {\'glyphicon\': true, \'glyphicon-ok\': hasSuccess(), \'glyphicon-remove\': hasError() }" aria-hidden="true"></span> <span ng-if="hasError() || hasSuccess()" id="{{form.key.slice(-1)[0] + \'Status\'}}" class="sr-only">{{ hasSuccess() ? \'(success)\' : \'(error)\' }}</span><div class="help-block" sf-message="form.description"></div></div>')}]);var lightApp=angular.module("lightApp",["angular-underscore/filters","schemaForm","pascalprecht.translate","ui.select","ui.sortable"]),chembiohubAssayApp=angular.module("chembiohubAssayApp",["chemdoodleAngular","lightApp","ngAnimate","ngCookies","ngMessages","ngResource","ngGrid","ngSanitize","ngTouch","ui.router","ui.bootstrap","ui.ace","dndLists","flow","ngClipboard","ngRaven","angular-underscore/filters","schemaForm","pascalprecht.translate","ui.select","ui.sortable","angularUtils.directives.dirPagination","angular-info-box","elasticui","schemaForm-file-upload","xeditable"]),arr=window.location.href.split("/"),part="dev",bit="",admin_base="/",base=arr[0]+"//"+arr[2];"localhost:9000"!=arr[2]?(bit=arr[3],part=bit+"/api",base=arr[0]+"//"+arr[2]+"/"+bit+"/"):admin_base="http://localhost:8000/";var path=arr[0]+"//"+arr[2]+"/"+part+"/",admin_url=admin_base+part,configuration={cbh_batch_upload:{list_endpoint:path+"cbh_batch_upload",schema:path+"cbh_batch_upload/schema"},cbh_project_types:{list_endpoint:path+"cbh_project_types",schema:path+"cbh_project_types/schema"},cbh_permissions:{list_endpoint:path+"cbh_permissions",schema:path+"cbh_permissions/schema"},cbh_projects:{list_endpoint:path+"cbh_projects",schema:path+"cbh_projects/schema"},cbh_saved_search:{list_endpoint:path+"cbh_saved_search",schema:path+"cbh_saved_search/schema"},cbh_skinning:{list_endpoint:path+"cbh_skinning",schema:path+"cbh_skinning/schema"},cbh_compound_batches:{list_endpoint:path+"cbh_compound_batches",schema:path+"cbh_compound_batches/schema"},users:{list_endpoint:path+"users",schema:path+"users/schema"},invitations:{list_endpoint:path+"invitations",schema:path+"invitations/schema"},cbh_draft_data:{list_endpoint:path+"datastore/cbh_draft_data",schema:path+"datastore/cbh_draft_data/schema"},cbh_multiple_batches:{list_endpoint:path+"cbh_multiple_batches",schema:path+"cbh_multiple_batches/schema"},instance_path:{url_frag:path,base:base,bit:bit},cbh_custom_field_configs:{list_endpoint:path+"cbh_custom_field_configs",schema:path+"cbh_custom_field_configs/schema",cbh_queries:{list_endpoint:path+"cbh_queries",schema:path+"cbh_queries/schema"}},admin:{list_endpoint:admin_url}};angular.module("chembiohubAssayApp").value("urlConfig",configuration),angular.module("chembiohubAssayApp").value("prefix",part);var initInjector=angular.injector(["ng"]),$http=initInjector.get("$http"),$q=initInjector.get("$q"),$timeout=initInjector.get("$timeout"),schemaGetter=function(a){var b={type:"object",properties:{},required:[]};return angular.forEach(a,function(a){angular.extend(b.properties,angular.copy(a.edit_schema.properties))}),b},formGetter=function(a,b,c){angular.isDefined(b)||(b="col-xs-12");var d=[];return angular.forEach(a,function(a){var e=angular.copy(a.edit_form.form[0]);e.htmlClass=b,angular.isDefined(e.options)&&angular.isDefined(e.options.async)&&(e.options.async.call=function(a,b,d){var f=e.options.async.url+"?custom__field__startswith="+d;return angular.isDefined(c)&&(f+="&custom_field="+e.key,f+="&project__project_key__in="+c.project_key),$http.get(f).then(function(a){e.permanent_items&&angular.forEach(e.permanent_items,function(b){a.data.unshift(angular.copy(b))}),d&&a.data.unshift({isTag:!0,label:d+" (adding new)",value:d});var b=[],c=[];a.data.reverse();var f;return angular.forEach(a.data,function(a){-1==b.indexOf(a.value)&&(a.value==d?f=a:(c.push(a),b.push(a.value)))}),f&&c.unshift(f),{data:c}})}),d.push(e)}),d};angular.module("chembiohubAssayApp").factory("CustomFieldConfig",function(){return{getSchema:schemaGetter,getForm:formGetter}});var skinReq=$http({method:"get",url:configuration.cbh_skinning.list_endpoint}),projReq=$http({method:"get",url:configuration.cbh_projects.list_endpoint,params:{schemaform:!0,limit:1e3,project_type__saved_search_project_type:!1}}),userReq=$http({method:"get",url:configuration.users.list_endpoint,params:{limit:1e4}});$q.all([skinReq,projReq,userReq]).then(function(a){var b=a[0],c=a[1],d=a[2];angular.module("chembiohubAssayApp").value("skinConfig",b.data),angular.module("chembiohubAssayApp").value("userList",d.data.objects);var e=null;angular.forEach(d.data.objects,function(a){a.is_logged_in&&(e=a)}),angular.module("chembiohubAssayApp").value("loggedInUser",e),angular.forEach(c.data.objects,function(a){a.schemaform={form:formGetter(a.custom_field_config.project_data_fields,"col-xs-12",a),schema:schemaGetter(a.custom_field_config.project_data_fields)},a.updateCustomFields=function(){$timeout(function(){a.recentlyUpdated=!1},1e3),a.recentlyUpdated||(a.recentlyUpdated=!0,angular.forEach(a.schemaform.form,function(b){angular.isDefined(b.options)&&angular.isDefined(b.options.async)&&b.options.async.call({},b.options,"").then(function(c){a.schemaform.schema.properties[b.key].items=c.data})}))}}),angular.module("chembiohubAssayApp").value("projectList",c.data);var f=c.data.objects.map(function(a){return a.project_key});window.projectKeys=f,window.projectUrlMatcher="/{projectKey:"+f.join("|")+"}/",angular.element(document).ready(function(){angular.bootstrap(angular.element(document.querySelector("#bodytest")),["chembiohubAssayApp"])})}),angular.module("chembiohubAssayApp").constant("euiHost",arr[0]+"//"+arr[2]+"/"+part+"/datastore"),angular.module("elasticsearch",[]).factory("esFactory",["$http","$q",function(a,b){return function(c){return{search:function(d){var e=b.defer(),f=b.defer();return a({method:"POST",url:c.host+"/"+d.index+"/_search",params:{size:d.size,from:d.from},data:d.body.toJSON(),timeout:e.promise}).then(function(a){f.resolve(a.data)},function(){f.reject.apply(this,arguments)}),f.promise.abort=function(){e.resolve()},f.promise["finally"](function(){f.promise.abort=angular.noop,e=f=null}),f.promise}}}}]),angular.module("chembiohubAssayApp").config(["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider",function(a,b,c){b.when("","/projects/list"),b.otherwise("/404"),c.defaultSquashPolicy("slash");a.state("cbh",{url:"",templateUrl:"views/cbh.html","abstract":!0,controller:"CbhCtrl",controllerAs:"cbh"}).state("404",{url:"/404",templateUrl:"404.html",controller:["$scope",function(a){}]}).state("cbh.search",{url:"/search?creator_uri=textsearch=created_by=editMode=&archived=&projectFrom=&scroll=&scrollTop=&sorts=&page=&compoundBatchesPerPage=&project__project_key__in&functional_group&flexmatch&related_molregno__chembl__chembl_id__in&with_substructure&similar_to&fpValue&created__gte&created__lte&molfile&smiles&search_custom_fields__kv_any&multiple_batch_id=&viewType=&doScroll=&showBlanks=&showNonBlanks=&limit&offset",resolve:{gridconfig:["CompoundListSetup",function(a){return a}],projectFactory:["ProjectFactory",function(a){return a}],messages:["MessageFactory",function(a){return a.getMessages()}]},views:{"":{templateUrl:"views/search.html"},"form@cbh.search":{controller:"SearchCtrl",templateUrl:"views/templates/search-template.html"},"newresults@cbh.search":{templateUrl:"views/compound-list-new.html",controller:"CompoundbatchCtrl"}}}).state("cbh.search_assays",{url:"/search-assays?textsearch=&l0=&l1=&l2=&start=&end=&useruris=",resolve:{},templateUrl:"views/searchassays.html",controller:"SearchAssaysCtrl",controllerAs:"searchassay"}).state("cbh.help",{url:"/help",resolve:{messages:["MessageFactory",function(a){return a.getMessages()}]},templateUrl:"views/help.html",controller:["$scope","$rootScope","$anchorScroll","$location",function(a,b,c,d){a.slides=[{image:"images/add-compounds-v2.37e0a762.gif",text:"Adding compounds"},{image:"images/searching-v2.e6adb6f0.gif",text:"Searching by tag"},{image:"images/searching-struc-v2.cb29fb82.gif",text:"Searching by structure"}],b.projName="",a.scrollTo=function(a){d.hash(a),c()}}]}).state("cbh.projects",{url:"/projects",resolve:{gridconfig:["CompoundListSetup",function(a){return a}],messages:["MessageFactory",function(a){return a.getMessages()}]},templateUrl:"views/projects.html",controller:"ProjectCtrl"}).state("cbh.users",{url:"/users",templateUrl:"views/users-list.html",resolve:{userList:["UserFactory",function(a){return a.get().$promise}],messages:["MessageFactory",function(a){return a.getMessages()}]},controller:["$scope","$rootScope","userList",function(a,b,c){a.users=c.objects,b.projName="Projects"}]}).state("cbh.user",{url:"/user/:username",templateUrl:"views/user-profile.html",resolve:{userFromList:["UserFactory","$stateParams","$q",function(a,b,c){var d=c.defer();return a.get({username:b.username},function(a){d.resolve(a)}),d.promise}],batchesForUser:["CBHCompoundBatch","userFromList","$q",function(a,b,c){var d=c.defer();return a.multiBatchForUser(b.objects[0].username).then(function(a){d.resolve(a)}),d.promise}],messages:["MessageFactory",function(a){return a.getMessages()}]},controller:["$scope","$rootScope","userFromList","batchesForUser",function(a,b,c,d){a.userFromList=c.objects[0],a.batchesForUser=d.objects,b.projName="Projects"}]}).state("cbh.projects.list",{url:"/list",templateUrl:"views/projects-list.html",controller:"ProjectlistCtrl"}).state("cbh.projects.project",{url:window.projectUrlMatcher,templateUrl:"views/project-full.html",controller:["$scope","$rootScope","$state","projectKey",function(a,b,c,d){b.projectKey=d,a.cbh.searchPage=function(){c.go("cbh.search",{project__project_key__in:d},{reload:!0})}}],resolve:{projectKey:["$stateParams",function(a){return a.projectKey}]}}).state("cbh.projects.project.addcompounds",{url:"addcompounds/?mb_id=&warningsFilter=&page=&compoundBatchesPerPage=&sorts=",templateUrl:"views/add-compounds2.html",controller:"AddCompoundsCtrl"}).state("cbh.projects.project.addsingle",{url:"addsingle/?mb_id=&warningsFilter=&idToClone=",templateUrl:"views/add-single-compound.html",controller:"AddSingleCompoundCtrl",resolve:{mol:["CBHCompoundBatch","$stateParams","$timeout",function(a,b,c){return b.idToClone?a.get(b.idToClone).then(function(a){return a}):{molecule:"",customFields:{},supplementaryFields:[]}}]}}).state("cbh.projects.project.assay",{url:"assay/",controllerAs:"assayctrl","abstract":!0,resolve:{project_with_forms:["projectKey","AddDataFactory",function(a,b){return b.pwf.get({project_key:a},function(a){return a}).$promise}]},controller:["$scope","$stateParams","$rootScope","AddDataFactory","project_with_forms","projectKey","CustomFieldConfig",function(a,b,c,d,e,f,g){var h=this;h.dfc_lookup={},h.proj=e.objects[0],a.cbh.appName="AssayReg",angular.forEach(h.proj.data_form_configs,function(a){a.get_main_schema=function(){return g.getSchema(a[a.last_level].project_data_fields)},a.get_main_form=function(){return g.getForm(a[a.last_level].project_data_fields)},h.dfc_lookup[a.resource_uri]=a,"l0"==a.last_level&&(h.l0_dfc=a,h.l0_cfc=h.l0_dfc.l0,h.l0_schema=a.get_main_schema(),h.l0_form=a.get_main_form())}),angular.forEach(h.proj.data_form_configs,function(a){a.full_permitted_children=a.permitted_children.map(function(a){return h.dfc_lookup[a]})})}],templateUrl:"views/demo-add.html"}).state("cbh.projects.project.assay.add_data",{url:"add_data/:dc?lev=&data_form_id=",templateUrl:"views/add-data.html",controller:"AddDataCtrl",controllerAs:"addctrl"}).state("cbh.projects.project.assay.edit_data",{url:"edit_data/:dc?lev=",templateUrl:"views/edit-data.html",controller:"EditDataCtrl",controllerAs:"editctrl"}).state("cbh.projects.project.assay.view_data",{url:"view_data/:dc",templateUrl:"views/view-data.html",controller:"ViewDataCtrl",controllerAs:"viewctrl"}).state("cbh.projects.project.assay.data_overview",{url:"data_overview/",templateUrl:"views/data-overview.html",controller:"DataOverviewCtrl",controllerAs:"dataoverviewctrl"})}]).run(["$http","$cookies","$rootScope","$document","$state","$urlMatcherFactory","LoginService","projectList","urlConfig","prefix",function(a,b,c,d,e,f,g,h,i,j){var k=j.split("/")[0];a.defaults.headers.post["X-CSRFToken"]=b[k+"csrftoken"],a.defaults.headers.patch["X-CSRFToken"]=b[k+"csrftoken"],a.defaults.headers.put["X-CSRFToken"]=b[k+"csrftoken"];var l=h.objects.map(function(a){return a.project_key});c.urlMatcher=f.compile("/{projectKey:"+l.join("|")+"}/?limit&offset"),c.$on("$stateChangeSuccess",function(a,b){d.scrollTop(0,0)}),c.$on("$stateChangeError",function(a,b,c,d,e,f){console.log(f)})}]).factory("authHttpResponseInterceptor",["$q","$location","urlConfig",function(a,b,c){return{response:function(b){return 401===b.status&&console.log("Response 401"),b||a.when(b)},responseError:function(b){return a.reject(b)}}}]).config(["ngClipProvider",function(a){a.setPath("bower_components/zeroclipboard/dist/ZeroClipboard.swf")}]).factory("globalInterceptor",["$q","$raven",function(a,b){return{response:function(b){return b||a.when(b)},responseError:function(b){return["4","5"].indexOf(b.status.toString().substring(0,1))>-1&&Raven.captureException(JSON.stringify(b.config),{extra:b.data}),a.reject(b)}}}]).config(["$httpProvider",function(a){a.interceptors.push("authHttpResponseInterceptor"),a.interceptors.push("globalInterceptor")}]),angular.module("chembiohubAssayApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),Array.prototype.chunk=function(a){var b=this;return[].concat.apply([],b.map(function(c,d){return d%a?[]:[b.slice(d,d+a)]}))},Array.prototype.clean=function(a){for(var b=0;b<this.length;b++)this[b]==a&&(this.splice(b,1),b--);return this};var app=angular.module("chembiohubAssayApp");app.factory("ChEMBLFactory",["$http",function(a){var b=function(b,c){var d=this,e="http://dee.sgc.ox.ac.uk:8000/chemblws/compounds/";this.queryChembl=function(b){var c=a.get(b);c.then(function(a){d.data=a.data.compounds[0]})},"inchi"==d.input_type?this.queryChembl(e+d.input_str+".json"):"inchikey"==d.input_type?this.queryChembl(e+"stdinchikey/"+d.input_str+".json"):"smiles"==d.input_type?this.queryChembl(e+"smiles/"+d.input_str+".json"):"chemblid"==d.input_type&&this.queryChembl(e+d.input_str+".json")};return b}]),angular.module("chembiohubAssayApp").factory("chemFileValidation",function(){var a=42;return{someMethod:function(){return a}}}),angular.module("chembiohubAssayApp").directive("chemsvg",["$compile",function(a){return{templateUrl:"views/templates/chemsvg.html",restrict:"E",link:function(a,b,c){a.checkLocal(),a.getSmiles(),a.$watch("smiles",function(){a.getSmiles()})},controller:["$scope","$http",function(a){a.getSmiles=function(){a.src="";var b={size:a.size,ctab:a.smiles};b.smarts=a.properties.substructureMatch,$http.post(a.finalUrl,b).then(function(b){a.src=b.data})},a.checkLocal=function(){a.finalUrl=a.baseUrl,a.properties?a.cdxml=a.properties.cdxml:a.cdxml=""}}],scope:{size:"=",smiles:"=",dataType:"=",baseUrl:"=",properties:"="}}}]),angular.module("chembiohubAssayApp").directive("processStep",function(){return{template:"",restrict:"E",link:function(a,b,c){a.getImageURL()},controller:["$scope",function(a){a.getImageURL=function(){switch(a.status){case"no_change_req":a.imageURL="images/skip_next2.bf38bf7b.svg";break;case"error":a.imageURL="images/error2.10541995.svg";break;case"processing":a.imageURL="images/loader.6594960f.gif";break;case"changed":a.imageURL="images/warning2.9d0ccb4b.svg"}}}],scope:{startSmiles:"=",endSmiles:"=",status:"=",name:"="}}}),angular.module("chembiohubAssayApp").filter("titlecase",function(){return function(a){var b=/^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;return a.replace(/[A-Za-z0-9\u00C0-\u00FF]+[^\s-]*/g,function(a,c,d){return c>0&&c+a.length!==d.length&&a.search(b)>-1&&":"!==d.charAt(c-2)&&("-"!==d.charAt(c+a.length)||"-"===d.charAt(c-1))&&d.charAt(c-1).search(/[^\s-]/)<0?a.toLowerCase():a.substr(1).search(/[A-Z]|\../)>-1?a:a.charAt(0).toUpperCase()+a.substr(1)})}}),angular.module("chembiohubAssayApp").directive("appProgress",[function(){return{templateUrl:"views/templates/app-progress.html",restrict:"E",scope:{wizard:"="},controller:function(){svgify()}}}]),angular.module("chembiohubAssayApp").factory("LoginService",["$resource","urlConfig",function(a,b){var c=b.users.list_endpoint,d=c;return a(d)}]),angular.module("chembiohubAssayApp").filter("notEmpty",function(){return function(a){return Object.keys(a).length>0}}),angular.module("chembiohubAssayApp").filter("toTrusted",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),angular.module("chembiohubAssayApp").filter("removeSpaces",function(){return function(a){return a.replace(/__space__/g," ")}}),angular.module("chembiohubAssayApp").factory("HTTPProject",["$stateParams",function(a,b){function c(a){var c=a||{};return c.data=c.data||{},c.data.projectKey=b.projectKey,c}var d={};return["delete","get","head","jsonp","post","put"].forEach(function(b){d[b]=function(d,e,f){var e=c(e);return a[b](d,e,f)}}),d}]),angular.module("chembiohubAssayApp").directive("projectList",function(){return{templateUrl:"views/templates/project-list.html",restrict:"E",controller:["$scope",function(a){a.projects=a.cbh.projects.objects}]}}),angular.module("chembiohubAssayApp").factory("ProjectFactory",["$resource","urlConfig",function(a,b){return a(b.cbh_projects.list_endpoint+"/:projectId",{projectId:"@projectId"},{update:{method:"PATCH"}})}]),angular.module("chembiohubAssayApp").controller("ProjectCtrl",["$scope","$rootScope","$state","ProjectFactory","MessageFactory","$stateParams","urlConfig",function(a,b,c,d,e,f,g){a.urlConfig=g,b.headline="Projects",b.subheading="Click 'Show Project List' to see your projects",a.help_lookup="projects_help",b.glyphicon="folder-open",a.getMessage=function(a){return e.getMessage(a)},a.messages=e.getMessages()}]),angular.module("chembiohubAssayApp").factory("MessageFactory",function(){var a={};a.getMessage=function(a){return b[a]?b[a]:""},a.getMessages=function(){return b},a.getLegends=function(){return e},a.getStatuses=function(){return c},a.getUploadActions=function(){return d};var b={wizard_intro_text:"To upload multiple compounds you will need a list of SMILES; an InChI key or list of InChI keys; or either a SD, ChemDraw or Excel file.",projects_help:"For each project you can view assay, inventory and chemical data dependent on the setup of the project. Editors can edit data, owners are able to invite new users to a project and change the usable fields or nominate other owners.",project_list_filter_help:"Narrow down the project list using this quick search box. Results will filter on project name and project type.",drawing_label_suppl:"Sketcher window provided by ChemDoodle.",drawing_label:"Draw your molecule here",file_upload_help_text:"Excel(xlsx), ChemDraw xml or SD files are accepted. For more detailed information, see the Help section.",assay_file_upload_help_text:"Excel(xlsx) are accepted. For more detailed information, see the Help section.",assay_file_use_template:"The system assumes that you are using data created from one of the available downloadable templates. Please ensure you have used this or your data may not map properly.",ids_not_processed:"No SMILES or InChI identifiers could be processed, please check the format, remove any spaces and try again.",file_error:"File cannot be processed even though the format appears valid. If you have questions please contact the ChemBio Hub team.",file_format_error:"File cannot be processed, the format is invalid. Files must be xlsx, cdxml, cdx or sdf format and labelled as such.",file_too_large:"File contains too many records to be able to process in one action - please consider splitting your input file into smaller parts.",oops:"Oops, should not have got here, if you have not pressed back on the browser, gone to an outdated bookmark or lost your data by refreshing please let the AssayReg team know. Click cancel to restart.",mapping_fields_help:"Drag column fields from your file to the appropriate custom mapping, or leave undragged to create a new custom field with that name.",edit_mode_unavailable_projects:"You cannot add single and edit at the same time. Edit and Add are only available when editing one project at a time where you have editor rights on that project.",edit_mode:"When in Edit mode, individual fields can be edited using the pencil icon and data can be filled down like in Excel. Edit and Add are only available when searching for one project at a time where you have editor rights on that project.",batch_reg_total_processed_0:"No substances were processed.",batch_reg_total_processed_1:"One substance was processed and:",batch_reg_total_processed_other:"substances were processed of which:",batch_reg_new_to_chemreg_other:"We check all of the projects you have access to to get this total.  If the number is zero it means all of your compounds already exist in AssayReg.",batch_prereg_to_public_single:"This substance is valid and was already registered as public.  A new private batch of this will be registered in this project.",batch_prereg_to_project_single:"This substance is valid and was already registered to this project.  A new private batch of this will be registered in this project.",batch_reg_new_to_chemreg_single:"This substance is not publically registered in ChemBio Hub AssayReg. The first batch of this substance will be registered to this project.",batch_overlaps:"Number of substances which have already been registered. New private batches will be registered in this project for each of these.",smiles_field:"Each line of data will be interpreted as a separate SMILES or InChI identifier. If you would like to be able to register compounds with a different type of identifier, please let the ChemBio Hub team know.",batch_duplicates:"Duplicate structures (with identical InChI keys).",batch_errors_single:"Number of errors in processing the molecule, possibly due to invalid valency",batch_errors_other:"Number of molecules could not be processed and will be ignored. They are located at positions ",field_errors_other:"Number of errors when attempting to map the fields in your uploaded data to the fields in AssayReg.",batch_reg_recent_registration_error:"You have already registered this batch today. Are you sure you wish to continue?",registration_success:"No batches were registered with the ids and properties shown below",registration_none_success:"No molecules were registered",registration_error:"An unknown error occurred when registering compounds, the ChemBio Hub team have been notified and will contact you when the issue has been investigated.",justSaved:"This data was recently saved, click start again or go back to the project page.",image_more_details:"Click the image for more details about that molecule",unmapped_values_written:"Any unmapped values will be written anyway.  User should contact administrator if they want the field to be available to the whole project.",mapped_values_written:"Mapped values will be written to the specified field against the project.  User should contact administrator if they want extra project fields.",total_values:"Total number of records submitted.",valid_structure_values:"Records with a valid structure as interpreted by AssayReg. If this result is zero for an Excel file you may need to identify the SMILES field below.",no_valid_structure_values:"Records with no valid structure as interpreted by AssayReg. This type of record can still be registered and searched for inventory management purposes.",error_total_values:"Data records that contain errors and cannot be processed. Check your input data and the info column below.",inchi_matching:"Compounds submitted have been compared to each other using their InChI key to detect duplicate structures and stereoisomers.",new_to_chemreg:"Compounds or items not previously registered to this project. These compounds or items may be present in other projects.",project_match_values:"Some of your compounds or items are already registered to this project. New batches of these compounds or items will be created in this project.",chemreg_match_values:"Some duplicate compounds have been detected in your data.",duplicate_count_values:"No duplicate compounds have been detected in your data.",project_data_field_download:"Download records from the table in Excel or SDF format. Note that the export function is only available when one project is selected and you are an editor of that project."},c={status_1:{name:"New",explanation:"The data has not been added to any project you have access to previously."},status_2:{name:"Duplicated record",explanation:"This data has been added previously with the exact same fields and values to this project."},status_3:{name:"Could not generate InChi",explanation:"For compound records, this indicates that the structure was recognised but contains bond types which are incompatible with the way we generate UOX IDs."},status_4:{name:"Data not processable",explanation:"For compound records in ChemDraw or SDF format, this indicates that the structure was incompatible with our conversion software and could not be recognised in the format inputted."},status_5:{name:"SMILES not processable",explanation:"For compound records in Excel format, the autodetected SMILES column for this record contained an invalid SMILES string and could not be processed."},status_6:{name:"Overlap",explanation:"For compound records, this indicates that an identical structure has been added to the system previously with different metadata or by another user where you have permission to see their uploaded data."}},d={action_1:{name:"New Batch",explanation:"This record will be added to the database when you click 'Save these records'"},action_2:{name:"Ignore",explanation:"This record will not be added to the database when you click 'Save these records'. Records which are automatically set to 'Ignore' contain incorrect or unprocessable structural data. You can choose to add these records as blinded compounds - the structural position will be ignored but a record will be created containing any additional data fields associated with the structure."}},e={legend_uox_id:{name:"UOx ID",explanation:"A unique identifier for this compound in this project. For each UOx ID there can be multiple batches."},legend_batch_id:{name:"Batch ID",explanation:"A sample of this compound - each time you re-register a compound you get a new batch. Batch IDs will soon be sequential per UOx ID. For each UOx ID there can be multiple batches"}};return a}),angular.module("chembiohubAssayApp").factory("CBHCompoundBatch",["$compile","$http","$q","$timeout","$cookies","urlConfig",function(a,b,c,d,e,f,g){var h={};h.getSingleMol=function(){return{acdAcidicPka:null,acdBasicPka:null,acdLogd:null,acdLogp:null,alogp:null,chemblId:"",
created:"",ctab:"",customFields:{},editableBy:{},id:null,knownDrug:0,medChemFriendly:null,modified:"",molecularFormula:"",molecularWeight:null,numRo5Violations:null,passesRuleOfThree:null,preferredCompoundName:null,rotatableBonds:0,smiles:"",species:null,stdCtab:"",stdInChiKey:""}},h.delete_index=function(a){a.objects=[];var c=b.post(f.cbh_compound_batches.list_endpoint+"/delete_index/",a).then(function(a){return a.data});return c},h.reindexModifiedCompound=function(a){var c={id:a};return b.post(f.cbh_compound_batches.list_endpoint+"/reindex_compound/",c)},h.markAsArchived=function(a){return b.post(f.cbh_compound_batches.list_endpoint+"/archive/",{id:a})},h.getSearchResults=function(a,c,d,e,g){var h={limit:c,offset:d,current_batch:a,sorts:g};e.bool.must.length+e.bool.must_not.length+e.bool.should.length>0?h.query=JSON.stringify(e):console.log(e.bool);var i=b.get(f.cbh_compound_batches.list_endpoint+"/get_part_processed_multiple_batch/",{params:h});return i},h.validateList=function(a,c){c.projectKey=a;var d=b.post(f.cbh_compound_batches.list_endpoint+"/validate_list/",c).then(function(a){return a.data});return d},h.validate=function(a,c){return b.post(f.cbh_compound_batches.list_endpoint+"/validate/",{ctab:c,projectKey:a})},h.createMultiBatch=function(a){var d=c.defer(),e=function(a){d.resolve(a)};a.cancellers.push(e);var g;return console.log("gothere"),"file"==a.config.type&&(g=b.post(f.cbh_compound_batches.list_endpoint+"/validate_files/",a.config,{timeout:d.promise})),"smilesdata"==a.config.type&&(g=b.post(f.cbh_compound_batches.list_endpoint+"/validate_list/",a.config,{timeout:d.promise})),"sketch"==a.config.type&&(g=b.post(f.cbh_compound_batches.list_endpoint+"/validate_drawn/",a.config,{timeout:d.promise})),g},h.saveSingleCompound=function(a,c,d,e){var g={projectKey:a,ctab:c,customFields:d,stereoSelected:"As Drawn"};return""!=c?g.molfile+="\n>  <_drawingBondsWedged>\nTrue\n\n$$$$":g.blinded_batch_id="EMPTY_ID",b.post(f.cbh_compound_batches.list_endpoint+"/",g)},h.saveMultiBatchMolecules=function(a){return b.post(f.cbh_compound_batches.list_endpoint+"/multi_batch_save/",a)},h.validateBatch=function(a,c){return b.post(f.cbh_compound_batches.list_endpoint+"/bulk/validate",{projectKey:a,ctab:molfile})},h.uploadBatch=function(a,c){return b.post(f.cbh_compound_batches.list_endpoint+"/bulk/upload",{projectKey:a,ctab:molfile})},h.fetchHeaders=function(a,c){return b.post(f.cbh_batch_upload.list_endpoint+"/headers/",{projectKey:a,file_name:c})},h.query=function(a){var c=b({url:f.cbh_compound_batches.list_endpoint+"/get_list_elasticsearch/",method:"GET",params:a}).then(function(a){return a.data});return c},h.get=function(a){var c=b({url:f.cbh_compound_batches.list_endpoint+"/"+a,method:"GET"}).then(function(a){return a.data});return c};var i=function(a,c){var d=b.patch(f.cbh_compound_batches.list_endpoint+"/"+a.id+"/",a).then(function(a){return a.data});return d};return h.patch=i,h.patchList=function(a,b){var d=(c.defer(),[]);return angular.forEach(a.objects,function(a){var c=a.project.split("/"),e=c[c.length-1];angular.forEach(b,function(b){b.id==e&&(a.project_key=b.project_key)}),d.push(i(a))}),c.all(d)},h.getListByVersion=function(a,b){c.defer();angular.forEach(a,function(a){var c=obj.project.split("/"),d=c[c.length-1];angular.forEach(b,function(a){a.id==d&&(obj.project_key=a.project_key)})})},h.patchTempList=function(a){var c=b.post(f.cbh_compound_batches.list_endpoint+"/update_temp_batches/",a).then(function(a){return a});return c},h.search=function(a,c){c&&(a.properties__archived="true");var d=b({url:f.cbh_compound_batches.list_endpoint,method:"GET",params:a}).then(function(a){return a.data});return d},h.multiBatchForUser=function(a){var c=b({url:f.cbh_multiple_batches.list_endpoint,method:"GET",params:{created_by:a,limit:1e3}}).then(function(a){return a.data});return c},h.paginate=function(a){var c=b({url:a,method:"GET"}).then(function(a){return a.data});return c},h.saveBatchCustomFields=function(a){return b.post(f.cbh_compound_batches.list_endpoint+"/multi_batch_custom_fields/",a)},h.validateFiles=function(a,c,d){var e=b.post(f.cbh_compound_batches.list_endpoint+"/validate_files/",{projectKey:a,file_name:c,struccol:d}).then(function(a){return a.data});return e},h}]);var ngFooter=function(a,b){a.pagingOptions=b.pagingOptions,a.maxRows=function(){var b=Math.max(a.totalServerItems);return b},a.$on("$destroy",a.$watch("totalServerItems",function(b,c){a.currentMaxPages=a.maxPages()})),a.maxPages=function(){return 0===a.maxRows()?1:Math.ceil(a.maxRows()/a.pagingOptions.pageSize)},a.pageForward=function(){var b=a.pagingOptions.currentPage;a.totalServerItems>0?a.pagingOptions.currentPage=Math.min(b+1,a.maxPages()):a.pagingOptions.currentPage++},a.pageBackward=function(){var b=a.pagingOptions.currentPage;a.pagingOptions.currentPage=Math.max(b-1,1)},a.pageToFirst=function(){a.pagingOptions.currentPage=1},a.pageToLast=function(){var b=a.maxPages();a.pagingOptions.currentPage=b},a.cantPageForward=function(){var c=a.pagingOptions.currentPage,d=a.maxPages();return a.totalServerItems>0?c>=d:b.data.length<1},a.cantPageToLast=function(){return a.totalServerItems>0?a.cantPageForward():!0},a.cantPageBackward=function(){var b=a.pagingOptions.currentPage;return 1>=b}};angular.module("chembiohubAssayApp").controller("BatchesCtrl",["$scope","$modal","$timeout","$q","$state","$stateParams","$location","gridconfig","projectKey","MessageFactory","CBHCompoundBatch","paramsAndForm",function(a,b,c,d,e,f,g,h,i,j,k,l){var m={};a.chemadder=!1;var n=function(){a.chemadder=!0};c(n,1e3);var o=f.multiple_batch_id;a.state=e.current,a.params=f,a.legends=j.getLegends(),m="cbh.search"!==a.state.name?o?{multiple_batch_id:o,project__project_key:i}:a.validatedData?{multiple_batch_id:a.validatedData.currentBatch,project__project_key:i}:{project__project_key:i}:l.params,a.tagFunction=function(a){var b={value:a,label:a,description:"",group:""};return b},a.projects=a.cbh.projects.objects,angular.forEach(a.projects,function(b){b.project_key==i&&(a.proj=b)}),a.dummyproj="$scope.state.data.dummyproj",a.projectKey=i,a.gridconfig=h,e.params.offset&&e.params.limit?(a.gridconfig.configObject.pagingOptions.pageSize=e.params.limit||20,a.gridconfig.configObject.pagingOptions.currentPage=parseInt(e.params.offset)/parseInt(e.params.limit)):(a.gridconfig.configObject.pagingOptions.pageSize=20,a.gridconfig.configObject.pagingOptions.currentPage=1),a.gridconfig.configObject.compounds=[],a.gridconfig.configObject.filters=m;var p=a.projectKey?"project__project_key="+a.projectKey+"&":"",q=a.validatedData?"multiple_batch_id="+m.multiple_batch_id+"&":"";"cbh.search"===a.state.name?a.gridconfig.configObject.paramsUrl=l.paramsUrl:a.gridconfig.configObject.paramsUrl=p+q,a.gridconfig.footerController=new ngFooter(a,a.gridconfig.configObject),c(function(){a.gridconfig.initializeGridParams().then(function(b){a.gridconfig.configObject.totalServerItems=b.meta.totalCount,a.gridconfig.configObject.compounds=b.objects},10)}),a.$watch("gridconfig.configObject.pagingOptions",function(b,c){b===c||b.currentPage===c.currentPage&&b.pageSize===c.pageSize||a.gridconfig.initializeGridParams().then(function(c){a.gridconfig.configObject.totalServerItems=c.meta.totalCount,a.gridconfig.configObject.compounds=c.objects,g.search("limit",b.pageSize).search("offset",parseInt(b.currentPage*b.pageSize)).replace()})},!0),a.modalInstance={},a.mol={},a.openSingleMol=function(c,d){angular.forEach(a.gridconfig.configObject.compounds,function(b){b.chemblId==c&&b.id==d&&(a.mol=b)}),a.modalInstance=b.open({templateUrl:"views/single-compound.html",size:"lg",resolve:{mol:function(){return a.mol},projectsWithCustomFieldData:["ProjectFactory",function(b){var c;return angular.forEach(a.cbh.projects.objects,function(b){b.id==a.mol.project_id&&(c=b)}),c}]},controller:["$scope","$modalInstance","mol","projectsWithCustomFieldData","$timeout",function(a,b,c,d,e){a.mol=c,a.myform=d.objects[0].schemaform.form;var f=d.objects[0].schemaform.form,g=Math.ceil(f.length/2);a.firstForm=angular.copy(f).splice(0,g),a.secondForm=angular.copy(f).splice(g),a.myform2=angular.copy(f),a.init=function(){a.keyValues=a.myform2.map(function(b){var c=b;angular.isDefined(b.key)&&(c=b.key);var d="";return angular.isDefined(a.mol.customFields[c])&&(d=a.mol.customFields[c]),d.constructor===Array&&(d=d.join(", ")),{key:c,value:d}}),a.firstList=a.keyValues.splice(0,g),a.secondList=a.keyValues,console.debug(a.firstList)},a.init(),a.removeAlert=function(){a.update_success=!1},a.updateBatch=function(){k.patch({customFields:a.mol.customFields,projectKey:i,id:a.mol.id}).then(function(b){a.mol=b,c=b,a.update_success=!0,a.init(),e(a.removeAlert,5e3)})},a.myschema=d.objects[0].schemaform.schema,a.modalInstance=b}]})},a.openHeadersLegend=function(){a.modalInstance=b.open({templateUrl:"views/legend.html",size:"md",controller:["$scope","$modalInstance","MessageFactory",function(a,b,c){a.modalInstance=b,a.legends=c.getLegends()}]})},a.exportSearch=function(b){a.gridconfig.exportFullResults(b)}}]),angular.module("chembiohubAssayApp").service("CompoundListSetup",["CBHCompoundBatch","$rootScope","$stateParams","$q","urlConfig",function(a,b,c,d,e){this.configObject={},this.configObject.projectKey="",this.configObject.compounds=[],this.configObject.totalServerItems=0,this.configObject.pagingOptions={pageSizes:[10,20,50],pageSize:10,currentPage:1},this.configObject.filters={},this.configObject.baseUrl=e.cbh_compound_batches.list_endpoint,this.configObject.paramsUrl="",this.configObject.gridOptions={data:"gridconfig.configObject.compounds",showColumnMenu:!0,enableColumnReordering:!0,totalServerItems:"gridconfig.configObject.totalServerItems",enablePaging:!0,pagingOptions:this.configObject.pagingOptions,showFooter:!0,enableRowSelection:!1,enableColumnResize:!0,enableCellSelection:!0,rowHeight:200,columnDefs:[{field:"ctab",displayName:"Structure",width:"20%",cellTemplate:"views/img-template.html",cellClass:"white-bg"},{field:"chemblId",displayName:"UOx ID",width:"20%",cellTemplate:"<div class='ngCellText'><a ng-click='openSingleMol(row.getProperty(col.field), row.getProperty(\"id\"))'>{{row.getProperty(col.field)}}</a></div>"},{field:"id",displayName:"Batch ID",width:"10%"},{field:"created",displayName:"Added on",cellFilter:"date",width:"10%"},{field:"createdBy",displayName:"Added by",width:"10%"},{field:"molecularWeight",displayName:"Mol Weight"},{field:"knownDrug",displayName:"Known Drug",visible:!1},{field:"stdInChiKey",displayName:"Std InChi Key",visible:!1},{field:"medChemFriendly",displayName:"MedChem Friendly",visible:!1},{field:"passesRuleOfThree",displayName:"Ro3 Pass",visible:!1},{field:"preferredCompoundName",displayName:"Name",visible:!1},{field:"molecularFormula",displayName:"Formula",visible:!1},{field:"numRo5Violations",displayName:"Ro5 Violations",visible:!1},{field:"rotatableBonds",displayName:"Rotatable Bonds",width:"15%"},{field:"acdLogp",displayName:"acdLogp",visible:!1}]},this.initializeGridParams=function(){var a=d.defer(),b=this.getPagedDataAsync(this.configObject.pagingOptions.pageSize,this.configObject.pagingOptions.currentPage).then(function(a){return a});return a.resolve(b),a.promise},this.getPagedDataAsync=function(b,c){var e=d.defer(),f=parseInt(c-1)*parseInt(b),g={limit:b,offset:f};angular.extend(this.configObject.filters,g);a.query(this.configObject.filters).then(function(a){e.resolve(a)});return e.promise},this.exportFullResults=function(b){var c=angular.copy(this.configObject.filters);angular.extend(c,{format:b,responseType:"arraybuffer",limit:0,offset:0});a["export"](c).then(function(a){var b=URL.createObjectURL(a);window.open(b,"_self"),URL.revokeObjectURL(objectURL)})}}]),angular.module("chembiohubAssayApp").controller("SearchCtrl",["$scope","$http","$rootScope","$filter","$stateParams","$location","$state","$timeout","projectFactory","gridconfig","CBHCompoundBatch","urlConfig","searchUrlParams","$modal","loggedInUser","ProjectTypeFactory","SavedSearchFactory",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(){a.cbh.searchForm.related_molregno__chembl__chembl_id__in&&(a.searchFormSchema.schema.properties.related_molregno__chembl__chembl_id__in.items=a.cbh.searchForm.related_molregno__chembl__chembl_id__in.map(function(a){return{value:a,label:a}})),a.cbh.searchForm.search_custom_fields__kv_any&&(a.searchFormSchema.schema.properties.search_custom_fields__kv_any.items=a.cbh.searchForm.search_custom_fields__kv_any.map(function(a){return{value:a,label:a.replace("|",": ")}}))}a.cbh.appName="ChemReg",a.searchFormSchema=angular.copy(a.cbh.projects.searchform),a.cbh.textsearch=e.textsearch,a.refresh=function(a,c,d){return b.get(c.async.url+"?chembl_id__chembl_id__startswith="+d)},a.refreshCustFields=function(c,d,e){var f=a.cbh.withoutCustomFieldsUrl+"&custom__field__startswith="+e;return b.get(d.async.url+"?"+f)};var s=m.setup(e,{molecule:{}});a.cbh.pf=s,a.cbh.searchForm=angular.copy(s.searchForm),a.cbh.setupParams=function(b){a.cbh.baseDownloadUrl=b.paramsUrl,a.cbh.withoutCustomFieldsUrl=b.paramsUrlWithoutCF},a.cbh.setupParams(s),a.uoxFormItem=d("filter")(a.searchFormSchema.form,{key:"related_molregno__chembl__chembl_id__in"},!0),a.uoxFormItem[0].options.async.call=a.refresh,a.custFieldFormItem=d("filter")(a.searchFormSchema.simple_form,{key:"search_custom_fields__kv_any"},!0),a.custFieldFormItem[0].options.async.call=a.refreshCustFields,a.projectFrom=e.projectFrom,a.projectObj={},angular.forEach(c.projects,function(b){b.project_key==a.projectFrom&&(a.projectObj=b)}),r(),a.$on("sf-render-finished",function(){h(function(){a.cbh.watcher=a.$watch(function(a){return a.cbh.textsearch},function(b,c){b!=c&&a.cbh.runSearch()},!0),a.cbh.watcher2=a.$watch(function(a){var b={};Object.keys(a.cbh.searchForm).map(function(c,d){"molecule"!=c&&(b[c]=a.cbh.searchForm[c])});return b},function(b,c){JSON.stringify(b)!=JSON.stringify(c)&&(1!=b.project__project_key__in.length&&a.cbh.editMode&&a.cbh.toggleEditMode(),a.cbh.runSearch())},!0)}),a.cbh.searchForm.molecule.molfileChanged=function(){e[a.cbh.searchForm.substruc]=a.cbh.searchForm.molecule.molfile,g.params[a.cbh.searchForm.substruc]=a.cbh.searchForm.molecule.molfile,f.search(e).replace()}}),a.cancel=function(){g.params={},e={};var b=m.setup({},{molecule:{}});a.cbh.searchForm=angular.copy(b.searchForm),g.transitionTo("cbh.search",{location:!0,inherit:!1,relative:null,notify:!0,reload:!0}),g.go(g.current.name,g.params,{reload:!0})},a.cbh.runSearch=function(b){c.$broadcast("getMolecule"),h(function(){var c=m.fromForm(a.cbh.searchForm,a.cbh.textsearch);c.params.doScroll=b,c.params.sorts=e.sorts,c.params.showNonBlanks=e.showNonBlanks,c.params.showBlanks=e.showBlanks,a.cbh.changeSearchParams(c.params,!0)},10)},a.cbh.isCustomFieldFiltered=function(a){return angular.isDefined(e.search_custom_fields__kv_any)&&e.search_custom_fields__kv_any.indexOf(a)>-1?!0:!1},a.cbh.repaintUiselect=function(){r(),c.$broadcast("schemaFormRedraw")},a.hasSearchBeenPerformed=function(){return g.params=={}?!1:!0},a.openNewSavedSearchPopup=function(){a.newSavedSearchModel={},a.modalInstance=n.open({templateUrl:"views/templates/new-saved-search-modal.html",size:"md",resolve:{newSavedSearchModel:function(){return a.newSavedSearchModel},searchFormSchema:function(){return a.searchFormSchema},saveSearch:function(){return a.saveSearch},projectFactory:function(){return i}},controller:["$scope","$modalInstance","newSavedSearchModel","searchFormSchema","ProjectTypeFactory","projectFactory","SavedSearchFactory","saveSearch",function(a,b,c,d,e,f,g,h){a.newSavedSearchModel=c,a.searchFormSchema=d,a.saveSearch=h,a.modalInstance=b,a.errormess="",a.cancel=function(){b.dismiss("cancel")},a.doValidation=function(c){console.log("doValidation being called",c),c.$valid&&""!=a.newSavedSearchModel.alias&&!c.$pristine?(a.saveSearch(),b.dismiss("cancel")):c.$pristine&&(a.errormess="You must add a title")}}]})},a.openMySavedSearchPopup=function(){a.links=[];var c={creator_uri:o.resource_uri};b.get(l.cbh_saved_search.list_endpoint+"/get_list_elasticsearch/",{params:c}).then(function(b){a.links=b.data.objects,a.modalInstance=n.open({templateUrl:"views/templates/my-searches-modal.html",size:"md",resolve:{links:function(){return a.links}},controller:["$scope","$modalInstance","links","loggedInUser",function(a,b,c,d){a.links=c,a.loggedInUser=d,a.modalInstance=b,a.cancel=function(){b.dismiss("cancel")},a.personalOrGroup=function(a){return"personal"}}]})})},a.saveSearch=function(){console.log("still being found"),p.get({saved_search_project_type:!0},function(c){a.savedSearchType=c.objects[0];var d=new Date;a.savedSearchType.project_template.name=a.newSavedSearchModel.alias+d.getTime().toString(),a.savedSearchType.project_template.custom_field_config.name=a.newSavedSearchModel.alias+d.getTime().toString(),i.save(a.savedSearchType.project_template,function(c){var d=(c.resource_uri,{project:c.resource_uri,projectKey:c.project_key,blindedBatchId:"EMPTY_STRING",customFields:{alias:a.newSavedSearchModel.alias,url:window.location.href},uncuratedFields:{},warnings:{},properties:{},errors:{}});console.log(d);var e=q.list;e.save(d,function(a){console.log("inside save");var c={id:a.id};b.post(l.cbh_saved_search.list_endpoint+"/reindex_compound/",c)})})})}}]),angular.module("chembiohubAssayApp").directive("buttonInput",function(){return{template:'<bootstrap-decorator>                    <div class="form-group " ng-class="" ng-init="">                        <label class="control-label " >{{label}}</label>                            <div class="form-group " >                              <div class="input-group">                                <input class="form-control" type="text" disabled ng-model="copyModel"></input>                                <a href="" clip-copy="copyModel" clip-click="" role="button" class="input-group-addon"><span class="glyphicon glyphicon-copy"> Copy</span></a>                            </div>                            </div>                            </div>                        </bootstrap-decorator>',restrict:"E",link:function(a,b,c){},controller:["$scope",function(a){}],scope:{copyModel:"=",disabled:"=",label:"="}}}),angular.module("chembiohubAssayApp").factory("UserFactory",["$resource","urlConfig",function(a,b){return a(b.users.list_endpoint,{username:"@username"},{})}]),angular.module("chembiohubAssayApp").factory("searchUrlParams",["$filter","$state",function(a,b){var c={};return c.setup=function(a,b){function c(c){b.molecule.molfile=a[c],a[c].indexOf("ChemDoodle")<0&&(b.smiles=a[c])}if(angular.isDefined(a.creator_uri)&&(b.creator_uri=decodeURIComponent(a.creator_uri).split(",")),angular.isDefined(a.archived)?b.archived=a.archived:b.archived="false",b.fpValue=a.fpValue,b.dateStart=a.created__gte,b.dateEnd=a.created__lte,angular.isDefined(a.project__project_key__in)?b.project__project_key__in=a.project__project_key__in.split(","):b.project__project_key__in=[],a.search_custom_fields__kv_any?b.search_custom_fields__kv_any=JSON.parse(a.search_custom_fields__kv_any):b.search_custom_fields__kv_any=[],a.related_molregno__chembl__chembl_id__in){a.related_molregno__chembl__chembl_id__in.split(",");b.related_molregno__chembl__chembl_id__in=a.related_molregno__chembl__chembl_id__in.split(",")}a.functional_group&&(b.functional_group=a.functional_group),a.multiple_batch_id?b.multiple_batch_id=a.multiple_batch_id:b.multiple_batch_id=void 0;return a.with_substructure?(b.substruc="with_substructure",c("with_substructure")):a.flexmatch?(b.substruc="flexmatch",c("flexmatch")):a.similar_to?(b.substruc="similar_to",c("flexmatch")):b.substruc="with_substructure",this.fromForm(b)},c.fromForm=function(b,c){function d(a){var b=["with_substructure","flexmatch","similar_to"];angular.forEach(b,function(b){b!=a&&(e[b]="")})}var e={};if(angular.isDefined(c)&&(e.textsearch=c),b.creator_uri?e.creator_uri=b.creator_uri.join(","):e.creator_uri=void 0,b.project__project_key__in&&(e.project__project_key__in=b.project__project_key__in.join(",")),b.multiple_batch_id?e.multiple_batch_id=b.multiple_batch_id:e.multiple_batch_id=void 0,b.related_molregno__chembl__chembl_id__in?e.related_molregno__chembl__chembl_id__in=b.related_molregno__chembl__chembl_id__in.join(","):delete e.related_molregno__chembl__chembl_id__in,b.functional_group?e.functional_group=b.functional_group:e.functional_group=void 0,b.smiles?e[b.substruc]=b.smiles:b.molecule&&""!=b.molecule.molfile?(e[b.substruc]=b.molecule.molfile,d(b.substruc)):(console.log("here"),e[b.substruc]=void 0),b.archived?e.archived=b.archived:e.archived="false",!angular.equals([],b.search_custom_fields__kv_any)&&angular.isDefined(b.search_custom_fields__kv_any)){var f="";f=JSON.stringify(b.search_custom_fields__kv_any),e.search_custom_fields__kv_any=f}else b.search_custom_fields__kv_any=[],e.search_custom_fields__kv_any="";if(b.dateStart)var g=a("date")(b.dateStart,"yyyy-MM-dd");if(b.dateEnd)var h=a("date")(b.dateEnd,"yyyy-MM-dd");e.created__gte=g,e.created__lte=h;var i=e.multiple_batch_id?"multiple_batch_id="+e.multiple_batch_id+"&":"",j=b.functional_group?"functional_group="+encodeURIComponent(b.functional_group)+"&":"",k=b.project__project_key__in?"project__project_key__in="+b.project__project_key__in.join(",")+"&":"",l=e.flexmatch?"flexmatch="+encodeURIComponent(e.flexmatch)+"&":"",m=e.with_substructure?"with_substructure="+encodeURIComponent(e.with_substructure)+"&":"",n=e.similar_to?"similar_to="+encodeURIComponent(e.similar_to)+"&":"",o=e.fpValue?"fpValue="+e.fpValue+"&":"",p=e.created__gte?"created__gte="+e.created__gte+"&":"",q=e.created__lte?"created__lte="+e.created__lte+"&":"",r=e.creator_uri?"creator_uri="+e.creator_uri+"&":"",s="archived="+e.archived,t=e.search_custom_fields__kv_any?"search_custom_fields__kv_any="+e.search_custom_fields__kv_any+"&":"",u=e.related_molregno__chembl__chembl_id__in?"related_molregno__chembl__chembl_id__in="+e.related_molregno__chembl__chembl_id__in+"&":"",v=angular.isDefined(c)?"textsearch="+c:"",w=r+i+k+j+l+u+m+n+o+p+q+v+s,x=w+t;return{searchForm:b,params:e,paramsUrl:x,paramsUrlWithoutCF:w}},c}]),angular.module("chembiohubAssayApp").controller("CompoundbatchCtrl",["$scope","$rootScope","$state","$stateParams","$timeout","CBHCompoundBatch","urlConfig","$window","$location","$anchorScroll","$filter","searchUrlParams",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(e,g){angular.forEach(b.projects,function(b,c){b.project_key==d.project__project_key__in&&b.editor&&(a.cbh.projAddingTo=a.cbh.projects.objects[c],a.cbh.projAddingTo.updateCustomFields())}),a.cbh.includedProjectKeys=a.cbh.searchForm.project__project_key__in.length>0?a.cbh.searchForm.project__project_key__in:a.cbh.projects.objects.map(function(a){return a.project_key}),o=String(Date.now());var h=String(o);g.limit=a.pagination.compoundBatchesPerPage.value,g.offset=(e-1)*parseInt(a.pagination.compoundBatchesPerPage.value),g.sorts=d.sorts,g.archived=d.archived,g.showBlanks=d.showBlanks,g.textsearch=d.textsearch,g.showBlanks&&(g.showBlanks=g.showBlanks.replace("customFields","custom_fields")),g.showNonBlanks=d.showNonBlanks,g.showNonBlanks&&(g.showNonBlanks=g.showNonBlanks.replace("customFields","custom_fields")),f.query(g).then(function(b){o==h&&(a.totalCompoundBatches=b.meta.totalCount,a.compoundBatches.data=b.objects,a.compoundBatches.backup=angular.copy(b.objects),b.objects.length>0?(a.imageCallback(),a.noData=""):a.pagination.current*parseInt(a.pagination.compoundBatchesPerPage.value)>a.totalCompoundBatches+a.pagination.compoundBatchesPerPage.value?(a.pageChanged(1),a.imageCallback()):(a.imageCallback(),"cbh.search"===c.current.name?a.noData="No Compounds Found. Why not try amending your search?":a.noData="No Compounds Found. To add compounds use the link above."),angular.isDefined(d.showBlanks)&&(a.compoundBatches.showBlanks=JSON.parse(d.showBlanks)),angular.isDefined(d.showNonBlanks)&&(a.compoundBatches.showNonBlanks=JSON.parse(d.showNonBlanks)))}),a.cbh.showSingle&&(a.toggleAddData(),a.cbh.showSingle=!1)}a.compoundBatches={data:[],redraw:0,sorts:[]},a.urlConfig=g,a.totalCompoundBatches=0,a.projects=a.cbh.projects.objects,a.$watch(function(a){return a.cbh.hideSearchForm},function(){j()});var n=l.setup(d,{molecule:{}});a.cbh.searchForm=angular.copy(n.searchForm),a.cbh.setupParams=function(b){a.cbh.baseDownloadUrl=b.paramsUrl,a.cbh.withoutCustomFieldsUrl=b.paramsUrlWithoutCF},a.cbh.setupParams(n),a.cbh.changeSearchParams=function(b,e){var f=l.fromForm(a.cbh.searchForm,a.cbh.textsearch);a.cbh.setupParams(f),e&&(a.pagination.current=1),c.params=b,d=b,c.go("cbh.search",b,{notify:!1,reload:!1,location:"replace",inherit:!0}),m(a.pagination.current,b)},a.changeView=function(){d.viewType=a.listOrGallery.choice,c.params.viewType=a.listOrGallery.choice,i.search(c.params)},a.cbh.setUpPageNumbers=function(){a.listOrGallery={choice:"list"},d.viewType&&(a.listOrGallery.choice=d.viewType),a.pagination={current:1};var b=[{label:"10/page",value:"10"},{label:"20/page",value:"20"},{label:"50/page",value:"50"},{label:"100/page",value:"100"}];if(a.itemsPerPage=angular.copy(b),a.pagination.compoundBatchesPerPage=a.itemsPerPage[2],angular.isDefined(d.sorts)&&(a.compoundBatches.sorts=JSON.parse(d.sorts)),angular.isDefined(d.showBlanks)&&(a.showBlanks=d.showBlanks),angular.isDefined(d.showNonBlanks)&&(a.showNonBlanks=d.showNonBlanks),angular.isDefined(d.compoundBatchesPerPage)){var c=k("filter")(a.itemsPerPage,d.compoundBatchesPerPage,!0);c[0]?a.pagination.compoundBatchesPerPage=c[0]:a.pagination.compoundBatchesPerPage=a.itemsPerPage[1]}angular.isDefined(d.page)&&(a.pagination.current=d.page)},a.cbh.patchRecord=function(b){a.compoundBatches.backup=angular.copy(a.compoundBatches.data),f.patch(b).then(function(b){f.reindexModifiedCompound(b.id).then(function(c){a.undoChanges=[b.id]})}),a.compoundBatches.redraw++},a.cbh.setUpPageNumbers(),a.blankForm=function(b,c){if(angular.isDefined(a.cbh.projAddingTo)){var d=angular.copy(a.cbh.projAddingTo.schemaform.form);angular.forEach(d,function(a){a.feedback=!1,a.disableSuccessState=!0}),a.myschema=angular.copy(a.cbh.projAddingTo.schemaform.schema),a.formChunks=d.chunk(Math.ceil(a.cbh.projAddingTo.schemaform.form.length/3)),a.newMol={customFields:{}},c&&(a.newMol.customFields=angular.copy(c.customFields),a.newMol.id=void 0,a.newMol.resource_uri=void 0),angular.forEach(a.formChunks,function(a){a.$pristine=!0}),b&&(a.addingData=!1)}},a.cbh.toggleEditMode=function(){a.cbh.editMode=!a.cbh.editMode,a.cbh.editMode&&(a.cbh.hideSearchForm=!0);var b=angular.copy(d);b.page=1,b.compoundBatchesPerPage=a.pagination.compoundBatchesPerPage.value,b.doScroll="true",b.editMode=a.cbh.editMode.toString(),a.cbh.changeSearchParams(b,!1)},a.editModeUnreachable=function(){var c=!0;return angular.forEach(b.projects,function(a,b){a.project_key==d.project__project_key__in&&a.editor&&(c=!1)}),c&&a.blankForm(!0),c},"true"==d.editMode||1==d.editMode?(a.cbh.editMode=!0,a.editModeUnreachable()&&a.cbh.toggleEditMode()):a.cbh.editMode=!1,a.addingData=!1,a.saveSingleCompound=function(b){f.saveSingleCompound(a.cbh.projAddingTo.project_key,"",a.newMol.customFields).then(function(c){f.reindexModifiedCompound(c.data.id).then(function(c){a.pageChanged(1),a.blankForm(b)})})},a.$on("cloneAnItem",function(b,c){a.cbh.editMode&&a.cbh.toggleEditMode(),a.addingData=!0,a.cbh.hideSearchForm=!0,a.blankForm(!1,c)}),a.toggleAddData=function(){a.addingData?a.addingData=!1:(a.addingData=!0,a.blankForm(),a.cbh.hideSearchForm=!0)},a.cbh.toggleArchiveFilter=function(){a.cbh.archiveFilter=!a.cbh.archiveFilter;var b=angular.copy(d);b.page=1,b.compoundBatchesPerPage=a.pagination.compoundBatchesPerPage.value,b.doScroll="true",b.archived=a.cbh.archiveFilter.toString(),a.cbh.changeSearchParams(b,!1)},a.changeNumberPerPage=function(b){var c=angular.copy(d);c.page=1,c.compoundBatchesPerPage=a.pagination.compoundBatchesPerPage.value,c.doScroll="true",a.cbh.changeSearchParams(c,!1)},a.pageChanged=function(b){var c=angular.copy(d);c.page=b,c.compoundBatchesPerPage=a.pagination.compoundBatchesPerPage.value,c.doScroll="true",a.cbh.changeSearchParams(c)},a.pageChanged2=function(b){var c=angular.copy(d);c.page=b,c.compoundBatchesPerPage=a.pagination.compoundBatchesPerPage.value,c.doScroll="false",a.cbh.changeSearchParams(c)},a.imageCallback=function(){a.compoundBatches.redraw++},a.cbh.blanksFilter=function(b,c){var e=angular.copy(d);if(e.page=1,e.showBlanks?e.showBlanks=JSON.parse(e.showBlanks):e.showBlanks=[],e.showNonBlanks?e.showNonBlanks=JSON.parse(e.showNonBlanks):e.showNonBlanks=[],"blanks"==c){var f=e.showBlanks.indexOf(b.data);-1==f?e.showBlanks.push(b.data):e.showBlanks.splice(f,1);var g=e.showNonBlanks.indexOf(b.data);g>-1&&e.showNonBlanks.splice(g,1)}else if("nonblanks"==c){var f=e.showNonBlanks.indexOf(b.data);-1==f?e.showNonBlanks.push(b.data):e.showNonBlanks.splice(f,1);var g=e.showBlanks.indexOf(b.data);g>-1&&e.showBlanks.splice(g,1)}e.showBlanks=JSON.stringify(e.showBlanks),e.showNonBlanks=JSON.stringify(e.showNonBlanks),a.cbh.changeSearchParams(e)};var o;a.nullSorts=function(){a.compoundBatches.sorts=[];var b=angular.copy(d);b.page=1,b.sorts=void 0,c.params=b,d=b,i.search(b),a.initialise()},a.cbh.addSort=function(b,c){for(var e=a.compoundBatches.sorts.length,f=!1;e--;)if(angular.isDefined(a.compoundBatches.sorts[e][b])){if(a.compoundBatches.sorts[e][b].order==c)var f=!0;a.compoundBatches.sorts.pop(e)}var g={};f||(g[b]={order:c,missing:"_last",unmapped_type:"string"},a.compoundBatches.sorts.unshift(g));var h=angular.copy(d);a.compoundBatches.sorts.length>0?h.sorts=JSON.stringify(a.compoundBatches.sorts):h.sorts=void 0,a.cbh.changeSearchParams(h,!0)},angular.isDefined(a.cbh.changesToUndo)||(a.cbh.changesToUndo=[]),a.undoChanges=function(){console.log("test"),a.currentlyLoading=!0,a.compoundBatches.data=angular.copy(a.compoundBatches.backup);var c=a.cbh.changesToUndo.map(function(b){return a.compoundBatches.data[b[0]]});f.patchList({objects:c},b.projects).then(function(b){angular.forEach(b,function(a){f.reindexModifiedCompound(a.id)}),a.compoundBatches.redraw++,a.currentlyLoading=!1,a.compoundBatches.backup=angular.copy(a.compoundBatches.data)})},a.$on("updateListView",function(){a.compoundBatches.backup=angular.copy(a.compoundBatches.data)}),a.cbh.saveChangesToCompoundDataInController=function(c,d){if(a.cbh.changesToUndo=[],angular.isDefined(c)&&c&&c.length>0){a.disableButtons=!0;var e=c.map(function(b){return a.compoundBatches.data[b[0]]});a.cbh.changesToUndo=c;var g={};g.objects=e,f.patchList(g,b.projects).then(function(a){angular.forEach(a,function(a){f.reindexModifiedCompound(a.id)})})}},a.initialise=function(){d.mb_id&&(a.current_dataset_id=d.mb_id,a.datasets[a.current_dataset_id]={multiplebatch:a.current_dataset_id}),d.warningsFilter?a.warningsFilter=d.warningsFilter:a.warningsFilter="",angular.isDefined(d.sorts)&&(a.compoundBatches.sorts=JSON.parse(d.sorts))},m(a.pagination.current,a.cbh.pf.params)}]),angular.module("chembiohubAssayApp").directive("handsoncompoundtable",["$timeout","$compile","renderers","$rootScope","$filter","$modal",function(a,b,c,d,e,f){return{template:"<div  ></div>",restrict:"E",transclude:!0,link:function(b,d,g){function h(a){var b=a.split("|");return b[1]}function i(a){var b=document.createElement("BUTTON"),c="";return a.noSort&&(c=" lightgrey"),b.innerHTML='<span class="glyphicon glyphicon-sort'+c+'"></span>',b.className="tableFilter",b}function j(a){var b=document.createElement("span");if(a.mappingOptions&&!a.copyto)b.className="pull-right alert-danger",b.style.marginRight="20px;",b.innerHTML='Unmapped <info-box lookup="unmapped_values_written" lookupitems="cbh.messages" right="true"></info-box>';else if(a.mappingOptions&&a.copyto){var c="<span></span>";1==a.automapped&&(c="<span>(auto)</span>"),b.className="pull-right alert-success",b.style.marginRight="20px;",b.innerHTML='<span class="glyphicon glyphicon-arrow-right"></span>'+a.copyto+c+'<info-box lookup="mapped_values_written" lookupitems="cbh.messages" right="true"></info-box></span>'}return b}function k(a,c){Handsontable.Dom.addEvent(a,"click",function(a){
a.preventDefault(),a.stopImmediatePropagation(),b.col=angular.copy(c),b.modalInstance=f.open({templateUrl:"views/templates/compound-table-filter.html",size:"md",resolve:{col:function(){return b.col},cbh:function(){return b.cbh}},controller:["$scope","$modalInstance","col","cbh","$timeout",function(a,b,c,d,e){a.col=c,a.modalInstance=b,a.cbh=d,a.cancel=function(){b.dismiss("cancel")}}]})})}var l,m;b.cbh.toggleMappedFieldInDirective=function(a,c){if(""===a)angular.forEach(b.uncuratedHeaders,function(a){a.name==c&&(delete a.operations,a.copyto="",a.automapped=!1)});else{var d=m[a],e=d.title;angular.forEach(b.uncuratedHeaders,function(a){if(a.name==c)if(a.copyto==e)a.copyto="",delete a.operations,a.automapped=!1;else{a.copyto=e,a.automapped=!1;var b=[];if("array"==d.type)b.push({op:"split",path:"/uncurated_fields/"+c}),b.push({op:"move",path:"/custom_fields/"+e,from:"/uncurated_fields/"+c});else{var f={op:"move",path:"/custom_fields/"+e,from:"/uncurated_fields/"+c};b.push(f),"date"==d.format&&b.push({op:"convertdate",path:"/custom_fields/"+e})}a.operations=b}})}l(),b.cbh.setMappedFieldInController(e,c)},b.refreshSingleCustField=function(a,b,c){var d=a.searchformSchema.cf_form[0].options.async.url;$http.get(d+"?custom__field__startswith="+b+"&custom_field="+a.knownBy).then(function(b){a.typeahead=b.data})},l=function(){m=[];var f=!1;angular.isDefined(b.uncuratedHeaders)&&(f=!0,"xlsx"==b.cbh.fileextension&&(m=[{title:"SMILES for chemical structures",type:"chemical"}]));var g=[],l=[],n=b.cbh.projects.objects,o=!1;angular.forEach(n,function(a){(!angular.isDefined(b.cbh.includedProjectKeys)||b.cbh.includedProjectKeys.indexOf(a.project_key)>-1)&&(a.project_type.show_compounds&&(o=!0),angular.forEach(a.schemaform.form,function(c){if(l.indexOf(c.key)<0){var d={knownBy:c.title,data:"customFields."+c.key,readOnly:!b.cbh.editMode,className:"htCenter htMiddle ",renderer:"customFieldRenderer",typeahed:[],field_type:c.field_type};l.push(c.key),g.push(d),m.push(angular.copy(a.schemaform.schema.properties[c.key]))}}))});var p=[];if(f){var q=b.uncuratedHeaders.map(function(a,b,c){var d=a.copyto,e=angular.copy(m).map(function(b,e){var f=b.type;"date"==b.format&&(f="stringdate");var g="";if(a.fieldErrors[f]===!0&&(b.disabled=!0,b.fieldError=!0,b.uiClass="",g=b),!g){c.map(function(c){c.name!=a.name?b.title.toLowerCase()==c.copyto.toLowerCase()&&(b.disabled=!0,b.alreadyMapped=c.name,b.uiClass="",g=b):b.title.toLowerCase()==c.copyto.toLowerCase()&&(b.uiClass="glyphicon-check",g=b,d=b.title)})}return g?g:(b.uiClass="glyphicon-unchecked",b)});return{sortOrder:"none",copyto:d,mappingOptions:e,knownBy:a.name,data:"uncuratedFields."+a.name,readOnly:!0,className:"htCenter htMiddle ",renderer:"linkRenderer",automapped:a.automapped}});p=o?[{noSort:!0,knownBy:"Structure",data:"image",renderer:"coverRenderer",readOnly:!0,className:"htCenter htMiddle "},{sortOrder:"none",knownBy:"Row",data:"id",readOnly:!0,className:"htCenter htMiddle "},{noSort:!0,readOnly:!0,knownBy:"Info",data:"originalSmiles",renderer:"infoRenderer"},{sortOrder:"none",knownBy:"Action",data:"properties.action",type:"dropdown",source:["New Batch","Ignore"],className:"htCenter htMiddle "},{sortOrder:"none",knownBy:"Inchi Key",data:"standardInchiKey",readonly:!0,renderer:"linkRenderer"}].concat(q):[{sortOrder:"none",knownBy:"Row",data:"id",readOnly:!0,className:"htCenter htMiddle "},{sortOrder:"none",knownBy:"Action",data:"properties.action",type:"dropdown",source:["New Batch","Ignore"],className:"htCenter htMiddle "}].concat(q)}else b.cbh.editMode&&(p=[{noSort:!0,knownBy:"Archive/Restore",data:"properties.archived",renderer:"archivedRenderer",readOnly:!0,className:"htCenter htMiddle "},{noSort:!0,knownBy:"Clone/Add Structure",data:"",renderer:"cloneRenderer",readOnly:!0,className:"htCenter htMiddle "}]),o&&(p=p.concat([{noSort:!0,knownBy:"Structure",data:"image",renderer:"coverRenderer",readOnly:!0,className:"htCenter htMiddle "}])),p=p.concat([{noSort:!0,knownBy:"UOx ID",data:"chemblId",renderer:"modalLinkRenderer",readOnly:!0,className:" htCenter htMiddle "},{knownBy:"Project",data:"project",readOnly:!0,className:"htCenter htMiddle ",renderer:"projectRenderer"}]),p=p.concat(g),b.cbh.editMode||(p=p.concat([{noSort:!0,knownBy:"Added By",data:"createdBy",readOnly:!0,className:"htCenter htMiddle "},{noSort:!0,knownBy:"Date",data:"timestamp",readOnly:!0,className:"htCenter htMiddle "},{knownBy:"Batch ID",data:"id",readOnly:!0,className:"htCenter htMiddle "},{noSort:!0,knownBy:"Upload ID",data:"multipleBatchId",readOnly:!0,className:"htCenter htMiddle "}])),o&&(p=p.concat([]));if(angular.isDefined(b.excluded)){var r=[];angular.forEach(p,function(a){var c=!0;angular.forEach(b.excluded,function(b){b==a.data&&(c=!1)}),c&&r.push(a)}),p=r}var s=p.map(function(a){return c.getColumnLabel(a,b)}),t={data:b.compounds,colHeaders:s,columns:p,minCols:p.length,afterGetColHeader:function(a,b){var c=i(p[a]),d=j(p[a]);for(k(c,p[a]);b.firstChild.lastChild!=b.firstChild.firstChild;)b.firstChild.removeChild(b.firstChild.lastChild);b.firstChild.appendChild(c),b.firstChild.appendChild(d),b.style["white-space"]="normal"},maxRows:b.compounds.length,renderAllRows:!0,fillHandle:"vertical",height:500};f?t.afterChange=function(a,c){b.cbh.saveChangesToTemporaryDataInController(a,c)}:(t.afterChange=function(a,c){b.cbh.saveChangesToCompoundDataInController(a,c)},t.beforeAutofill=function(a,c,d){for(var e=a.col;e<=c.col;e++)if("uiselecttags"==p[e].field_type)for(var f=a.row;f<=c.end;f++);else if("Archive/Restore"==p[e].knownBy){var g=(b.cbh.projects.objects,a.row),h=(this.getSourceDataAtRow(g),this.getCell(g-1,e)),i=!1,j=h.children[0].children[0];if(console.log(j.className),"btn btn-success"==j.className)var i=!0;console.log("start",a.row);for(var f=a.row;f<=c.row;f++){var k=this.getCell(f,e),l=k.children[0],m=this.getSourceDataAtRow(f),n=m.project.split("/");n[n.length-1];console.log("getting here"),i&&"btn btn-danger"==l.children[0].className?(l.innerHTML="<button class='btn btn-success'><span class=' glyphicon glyphicon-ok'></span>&nbsp;Restore</button>",m.toArchive=!0,m.properties.archived=!0,l.click()):i||"btn btn-success"!=l.children[0].className||(l.innerHTML="<button class='btn btn-danger'><span class='glyphicon glyphicon-remove'></span>&nbsp;Archive</button>",m.toArchive=!1,m.properties.archived=!1,l.click())}}});var u=c.getRenderers(b,f);if(angular.isDefined(b.elem)){b.elem.scrollLeft(),$(window).scrollTop()}angular.forEach(t.columns,function(a){angular.isDefined(a.renderer)&&(a.renderer=u[a.renderer])});var v,w=document.createElement("DIV");for(w.className=w.className+" handsontable";d[0].firstChild;)d[0].removeChild(d[0].firstChild);d[0].appendChild(w);var v=new Handsontable(w,t),x=d[0].firstChild.id;b.hotId="#"+x;var y=$(b.hotId);y.wrap("<div id='myid' ></div>"),a(function(){b.width=0,angular.forEach(t.columns,function(a,c){a.myColWidth=v.getColWidth(c),b.width+=a.myColWidth,a.noSort||(a.sortOrder="none"),angular.forEach(b.sorts,function(b){angular.isDefined(b[a.data])&&(a.sortOrder=b[a.data].order)}),a.showBlank=!1,a.showNonBlank=!1,b.showNonBlanks&&angular.forEach(b.showNonBlanks,function(b){b==a.data&&(a.showNonBlank=!0)}),b.showBlanks&&angular.forEach(b.showBlanks,function(b){b==a.data&&(a.showBlank=!0)}),a.typeahead=[],a.searchForm=angular.copy(b.searchForm),a.searchformSchema=angular.copy(b.searchformSchema),angular.isDefined(a.searchformSchema)&&(a.searchformSchema.cf_form[0].options.custom_field=a.knownBy,a.searchForm.search_custom_fields__kv_any&&angular.forEach(a.searchForm.search_custom_fields__kv_any,function(b,c){a.searchForm.search_custom_fields__kv_any=e("filter")(a.searchForm.search_custom_fields__kv_any,function(b,c){return b.split("|")[0]==a.knownBy}),a.searchformSchema.schema.properties.search_custom_fields__kv_any.items=a.searchForm.search_custom_fields__kv_any.map(function(a){return{value:a,label:h(a)}})}))}),b.columns=t.columns,$(".btn-toggle").dropdown(),b.elem=$("#myid")}),b.hot1=v},b.$watch("redraw",function(a,b){l(),console.log("redraw being called via watch")},!0),b.$on("updateListView",function(){l()})},scope:{redraw:"=",compounds:"=",cbh:"=",sorts:"=",uncuratedHeaders:"=",columns:"=",excluded:"=",warningsFilter:"=",searchformSchema:"=",searchForm:"=",showBlanks:"=",showNonBlanks:"=",messages:"=",plugins:"="}}}]),angular.module("chembiohubAssayApp").directive("disableAnimation",["$animate",function(a){return{restrict:"A",link:function(b,c,d){d.$observe("disableAnimation",function(b){a.enabled(!b,c)})}}}]),angular.module("chembiohubAssayApp").controller("AddCompoundsCtrl",["$scope","$state","$stateParams","$cookies","$timeout","$location","$filter","projectKey","prefix","urlConfig","CBHCompoundBatch","MessageFactory","renderers","searchUrlParams","$modal","skinConfig",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){a.skinConfig=p.objects[0],a.csrftoken=d[i.split("/")[0]+"csrftoken"],a.flowinit={target:j.instance_path.url_frag+"flow/upload/",headers:{"X-CSRFToken":a.csrftoken},generateUniqueIdentifier:function(a){return a.name+"-"+a.size+"-"+Date.now()}},a.projects=a.cbh.projects.objects,angular.forEach(a.projects,function(b){b.project_key==h&&(a.proj=b)}),a.toggleDataSummary={showFlag:!0},a.cbh.appName="ChemReg",a.topLink=function(){b.go("cbh.projects.list.project",{projectKey:h})},a.setLoadingMessageHeight=function(){var a=$(window).scrollTop();$("#loading-message").css("top",a+200+"px")},a.saveTemporaryCompoundData=function(){a.setLoadingMessageHeight(),a.currentlyLoading=!0,k.saveMultiBatchMolecules(a.datasets[a.current_dataset_id].config).then(function(c){a.cbh.hideSearchForm=!0,b.transitionTo("cbh.search",{multiple_batch_id:a.datasets[a.current_dataset_id].config.multiplebatch,projectFrom:h,project__project_key__in:h},{location:!0,inherit:!1,relative:null,notify:!0})},function(b){a.currentlyLoading=!1})},a.cbh.saveChangesToTemporaryDataInController=function(b,c){if(b&&b.length>0){a.disableButtons=!0;var d=b.map(function(b){return a.compoundBatches.data[b[0]]}),e=angular.copy(a.datasets[a.current_dataset_id].config);e.objects=d,k.patchTempList(e).then(function(b){a.compoundBatches.savestats=b.data.savestats})}},a.cbh.toggleWarningsFilter=function(d){var e=d;a.warningsFilter==d&&(e="");var f=angular.copy(c);f.page=1,f.warningsFilter=e,b.transitionTo(b.current.name,f,{location:!0,inherit:!1,relative:b.$current,notify:!1}),c=f,a.initialise()},a.cbh.openStatusExplanation=function(){a.modalInstance=o.open({templateUrl:"views/statuses.html",size:"md",controller:["$scope","$modalInstance","MessageFactory",function(a,b,c){a.modalInstance=b,a.legends=c.getStatuses(),a.actions=c.getUploadActions()}]})},a.cbh.setMappedFieldInController=function(b,c){a.datasets[a.current_dataset_id].config.headers=a.compoundBatches.uncuratedHeaders,a.datasets[a.current_dataset_id].config.struccol==c&&"SMILES for chemical structures"==b?(a.datasets[a.current_dataset_id].config.struccol="",a.createMultiBatch()):"SMILES for chemical structures"==b?(a.datasets[a.current_dataset_id].config.struccol=c,a.createMultiBatch()):k.saveBatchCustomFields(a.datasets[a.current_dataset_id].config)},a.cancelFile=function(d){var e={projectKey:c.projectKey};a.datasets[a.current_dataset_id].config.multiplebatch&&k.delete_index(a.datasets[a.current_dataset_id].config),a.setNull(),b.transitionTo(b.current.name,e,{location:!1,inherit:!1,relative:b.$current,notify:!0})},a.datasets={none:{config:{state:"add","new":0,blinded:0,total:0,overlaps:0,errors:0,field_errors:0,dupes:0}}},a.setNull=function(){a.current_dataset_id="none",a.setup()},a.changeView=function(){c.viewType=a.listOrGallery.choice,b.params.viewType=a.listOrGallery.choice,f.search(b.params)},a.setup=function(){a.inputData={inputstring:""},a.filedata={},a.filesUploading=!1,a.dataReady=!1,a.stateName=b.current.name,a.urlConfig=j,a.totalCompoundBatches=0,a.listOrGallery={choice:"list"},c.viewType&&(a.listOrGallery.choice=c.viewType),a.listPerPage=[{label:"10/page",value:"10"},{label:"20/page",value:"20"},{label:"50/page",value:"50"},{label:"100/page",value:"100"}],a.compoundBatches={data:[],sorts:[],excluded:[],redraw:0,columns:[]},a.itemsPerPage=angular.copy(a.listPerPage),a.pagination={current:1,compoundBatchesPerPage:a.itemsPerPage[2]}},a.nullSorts=function(){a.compoundBatches.sorts=[];var d=angular.copy(c);d.page=1,d.sorts=void 0,b.transitionTo(b.current.name,d,{location:!0,inherit:!1,relative:b.$current,notify:!1}),c=d,a.initialise()},a.cbh.renderFilterLink=m.renderFilterLink,a.cbh.fileextension="",a.cbh.addSort=function(d,e){for(var f=a.compoundBatches.sorts.length,g=!1;f--;)if(angular.isDefined(a.compoundBatches.sorts[f][d])){if(a.compoundBatches.sorts[f][d].order==e)var g=!0;a.compoundBatches.sorts.pop(f)}var h={};g||(h[d]={order:e,missing:"_last",unmapped_type:"string"},a.compoundBatches.sorts.unshift(h));var i=angular.copy(c);a.compoundBatches.sorts.length>0?i.sorts=JSON.stringify(a.compoundBatches.sorts):i.sorts=void 0,b.transitionTo(b.current.name,i,{location:!0,inherit:!1,relative:b.$current,notify:!1}),c=i,a.initialise()},a.setNull(),a.assignFile=function(b,c,d){a.current_dataset_id=b,a.cbh.fileextension=c;var f={file_name:b,multiplebatch:null,type:"file",fileextension:c,projectKey:h,struccol:"",state:"validate"};-1==["sdf","xlsx","cdx","cdxml"].indexOf(c)?(f.errors=[l.getMessage("file_format_error")],f.status="add"):a.filesInProcessing=!0,a.datasets[a.current_dataset_id]={config:f,cancellers:[]},e(a.createMultiBatch,200)},a.sketchMolfile={molecule:{}},a.molecule={molfile:""},a.createMultiBatch=function(){a.setLoadingMessageHeight(),a.currentlyLoading=!0,e(function(){a.setLoadingMessageHeight()}),k.createMultiBatch(a.datasets[a.current_dataset_id]).then(function(d){a.currentlyLoading=!1,a.filesInProcessing=!1,a.datasets[a.current_dataset_id].config=d.data,a.dataReady=!0,a.compoundBatches.uncuratedHeaders=d.data.headers,a.imageCallback(),a.compoundBatches.data=d.data.objects,a.compoundBatches.savestats=d.data.savestats,a.totalCompoundBatches=d.data.batchstats.total,b.go(b.current.name,{mb_id:a.datasets[a.current_dataset_id].config.multiplebatch,projectKey:c.projectKey},{location:!0,inherit:!1,relative:b.$current,notify:!0})},function(b){if("file"==a.datasets[a.current_dataset_id].config.type){var c=l.getMessage(b.data.error);angular.isDefined(c)&&""!==c?a.datasets[a.current_dataset_id].config.errors=[c]:a.datasets[a.current_dataset_id].config.errors=[l.getMessage("file_error")],a.skinConfig.file_errors_from_backend&&(a.datasets[a.current_dataset_id].config.errors[0]=b.data.error)}"smilesdata"==a.datasets[a.current_dataset_id].config.type&&(a.datasets[a.current_dataset_id].config.errors=[l.getMessage("ids_not_processed")]),a.datasets[a.current_dataset_id].config.status="add",a.dataReady=!1,a.currentlyLoading=!1})},a.refreshCustFields=function(a,b,c){return $http.get(b.async.url+"?custom__field__startswith="+c+"&custom_field="+b.custom_field)},a.processSmilesData=function(){a.current_dataset_id=a.inputData.inputstring;var b={multiplebatch:null,smilesdata:a.inputData.inputstring,type:"smilesdata",projectKey:h,struccol:"",state:"validate"};a.datasets[a.current_dataset_id]={config:b,cancellers:[]},a.createMultiBatch()},a.initialise=function(){if(c.viewType&&(a.listOrGallery.choice=c.viewType),c.mb_id&&(a.current_dataset_id=c.mb_id,a.datasets[a.current_dataset_id]={multiplebatch:a.current_dataset_id}),c.warningsFilter?a.warningsFilter=c.warningsFilter:a.warningsFilter="",angular.isDefined(c.compoundBatchesPerPage)){var b=g("filter")(a.itemsPerPage,c.compoundBatchesPerPage,!0);b[0]?a.pagination.compoundBatchesPerPage=b[0]:a.pagination.compoundBatchesPerPage=a.itemsPerPage[2]}else a.pagination.compoundBatchesPerPage=a.itemsPerPage[2];angular.isDefined(c.page)&&(a.pagination.current=c.page),angular.isDefined(c.sorts)&&(a.compoundBatches.sorts=JSON.parse(c.sorts)),angular.isDefined(c.mb_id)&&q(a.pagination.current)},a.cbh.includedProjectKeys=[a.proj.project_key],a.changeNumberPerPage=function(d){var e=angular.copy(c);e.page=1,e.compoundBatchesPerPage=a.pagination.compoundBatchesPerPage.value,e.viewType=d,e.doScroll="true",b.transitionTo(b.current.name,e,{location:!0,inherit:!1,relative:b.$current,notify:!1}),c=e,a.initialise()},a.pageChanged=function(d){var e=angular.copy(c);e.page=d,e.compoundBatchesPerPage=a.pagination.compoundBatchesPerPage.value,e.doScroll="true",b.transitionTo(b.current.name,e,{location:!0,inherit:!1,relative:b.$current,notify:!1}),c=e,a.initialise()},a.pageChanged2=function(b){a.pageChanged()};a.imageCallback=function(){e(function(){a.compoundBatches.redraw++})};var q=function(d){var e=a.pagination.compoundBatchesPerPage.value,f=(d-1)*a.pagination.compoundBatchesPerPage.value,h={bool:{must:[],should:[],must_not:[]}};if(""!=a.warningsFilter){var i="true",j=a.warningsFilter;if(a.warningsFilter.indexOf("properties")>-1&&(j=a.warningsFilter.split("|")[0],i=a.warningsFilter.split("|")[1]),"warnings.withstructure"==a.warningsFilter)h.bool.must_not.push({term:{"warnings.withoutstructure":"true"}}),h.bool.must_not.push({term:{"warnings.parseError":"true"}});else{var l={term:{}};l.term[j]=i,h.bool.must.push(l)}}else console.log(a.warningsFilter);a.compoundBatches.data=[],k.getSearchResults(c.mb_id,e,f,h,c.sorts).then(function(d){a.cbh.fileextension=d.data.fileextension,a.totalCompoundBatches=d.data.meta.totalCount,a.compoundBatches.data=d.data.objects,a.compoundBatches.uncuratedHeaders=d.data.headers,a.compoundBatches.savestats=d.data.savestats,a.current_dataset_id=c.mb_id,a.datasets[a.current_dataset_id]={config:d.data,cancellers:[]},a.searchFormSchema=angular.copy(a.cbh.projects.searchform);n.setup(c,{molecule:{}});a.searchForm=!1;var e=g("filter")(a.searchFormSchema.cf_form,{key:"search_custom_fields__kv_any"},!0);if(e[0].options.async.call=a.refreshCustFields,a.dataReady=!0,d.data.objects.length>0){"gallery"==a.listOrGallery.choice?100:75;a.imageCallback()}else a.pagination.current*parseInt(a.pagination.compoundBatchesPerPage.value)>a.totalCompoundBatches?1!=a.pagination.current&&a.pageChanged(1):"cbh.search"===b.current.name?a.noData="No Compounds Found. Why not try amending your search?":a.noData="No Compounds Found. To add compounds use the link above."})};a.initialise()}]),angular.module("chembiohubAssayApp").factory("renderers",["$timeout","$compile","$state","$rootScope",function(a,b,c,d){function e(a,b){var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,d=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join(""),a.replace(d,"").replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""})}function f(a,b,c){var d="lightgrey";return a==b&&(d="blue"),'<a class="btn btn-sm btn-default" title="'+c+'" onclick="angular.element(this).scope().cbh.toggleWarningsFilter(&quot;'+b+'&quot;)" ><span class="glyphicon glyphicon-filter '+d+' " ></span></a>'}var g={getRenderers:function(a,b){var f,g=b,h=function(a,b,c,d,f,g,h){var i=Handsontable.helper.stringify(g);if(i=e(i,""),"href"==h.field_type){var j=document.createElement("a");i.length>0&&(":"==i.substring(1,1)&&(i="file://"+i),j.innerHTML="view",j.href=i,j.target="_blank"),Handsontable.Dom.empty(b),b.className+="htCenter htMiddle ",b.appendChild(j)}else if("imghref"==h.field_type){var j=document.createElement("a");i.length>0&&(":"==i.substring(1,1)&&(i="file://"+i),j.innerHTML="view",j.href=i,j.target="_blank"),Handsontable.Dom.empty(b),b.className+="htCenter htMiddle ";var k=document.createElement("img");k.src=i,k.className="img-responsive",b.appendChild(k),b.appendChild(j),b.setAttribute("style","min-height:100px;min-width:100px;max-width:100px")}else if(0==i.indexOf("http")&&i.indexOf("//")>0){var j=document.createElement("a"),l=i.split("//")[1];j.innerHTML=l,l.length>30&&(j.innerHTML=l.substring(0,29)+"..."),j.href=i,j.target="_blank",Handsontable.Dom.empty(b),b.className+="htCenter htMiddle ",b.appendChild(j)}else b.className+=" htMiddle ","standardInchiKey"==f?(b.innerHTML=i.substring(0,10)+"...",h.readOnly=!0):b.innerHTML='<div class="">'+i+"</div>";return b},i={infoRenderer:function(a,b,c,d,e,f,g){var h=a.getSourceDataAtRow(c),i="<ul class='noindent'>",j=[["parseError","<li ><span class='alert-danger'>Data not processable</span></li>"],["smilesParseError","<li ><span class='alert-danger'>SMILES not processable: </span><br><small class='blue'>SMILESHERE</small></li>"],["inchiCreationError","<li ><span class='alert-danger'>Could not generate InChi: </span><br><small class='blue'>SMILESHERE</small></li>"],["duplicate","<li ><span class='alert-warning'>Duplicated record</span></li>"],["new","<li ><span class='alert-success'>New</span></li>"],["overlap","<li ><span class='alert-info'>Overlap</span></li>"]];return angular.forEach(j,function(a){angular.isDefined(h.warnings[a[0]])&&(i+=a[1])}),i+="</ul>",b.className+=" htMiddle ",b.innerHTML=i.replace("SMILESHERE",h.originalSmiles),b},centeredNumericRenderer:function(a,b,c,d,e,f,g){return Handsontable.renderers.TextRenderer.apply(this,arguments),g.type="numeric",g.format="0.00",b.className="htCenter htMiddle",b},safeHtmlRenderer:function(a,b,c,d,f,g,h){var i=Handsontable.helper.stringify(g);return i=e(i,"<em><b><strong><a><big>"),b.innerHTML=i,b},archivedRenderer:function(a,b,c,d,e,g,h){var i=f.cbh.projects.objects,j=a.getSourceDataAtRow(c),k=j.project.split("/"),l=k[k.length-1];angular.forEach(i,function(a){if(a.id==l){var c=!1,d="<button class='btn btn-success'><span class=' glyphicon glyphicon-ok'></span>&nbsp;Restore</button>";if(null==g||"false"==g||0==g){var d="<button class='btn btn-danger'><span class='glyphicon glyphicon-remove'></span>&nbsp;Archive</button>";c=!0}var e=document.createElement("a");return e.innerHTML=d,Handsontable.Dom.addEvent(e,"click",function(b){b.preventDefault(),j.properties.archived=c,g=c,j.projectKey=a.project_key,f.cbh.patchRecord(j)}),Handsontable.Dom.empty(b),b.className+="htCenter htMiddle",b.appendChild(e),b}})},cloneRenderer:function(a,b,e,g,h,i,j){var k=f.cbh.projects.objects,l=a.getSourceDataAtRow(e),m=l.project.split("/"),n=m[m.length-1];angular.forEach(k,function(a){if(a.id==n){var e="<button class='btn btn-primary'><span class=' glyphicon glyphicon-copy'></span>&nbsp;"+a.project_type.copy_action_name+"</button>",f=document.createElement("a");return f.innerHTML=e,Handsontable.Dom.addEvent(f,"click",function(b){b.preventDefault(),a.project_type.show_compounds?c.go("cbh.projects.project.addsingle",{projectKey:a.project_key,idToClone:l.id},{reload:!0}):d.$broadcast("cloneAnItem",l)}),Handsontable.Dom.empty(b),b.className+="htCenter htMiddle",b.appendChild(f),b}})},modalLinkRenderer:function(a,b,c,d,g,h,i){if(null==h)return b;var j=Handsontable.helper.stringify(h);j=e(j,"");var k=document.createElement("a");return k.innerHTML=j,Handsontable.Dom.addEvent(k,"mousedown",function(b){var d=a.getSourceDataAtRow(c);f.cbh.openSingleMol(d)}),Handsontable.Dom.empty(b),b.className+="htCenter htMiddle courier",b.appendChild(k),b},projectRenderer:function(a,b,c,d,e,g,h){var i=a.getSourceDataAtRow(c),j=i.project.split("/"),k=j[j.length-1],l=f.cbh.projects.objects;angular.forEach(l,function(a){return a.id==k?(Handsontable.Dom.empty(b),b.innerHTML=a.name,b.className+="htCenter htMiddle",b):void 0})},linkRenderer:h,customFieldRenderer:function(a,b,c,d,e,g,i){if(b=h(a,b,c,d,e,g,i),0==i.readOnly){b.className+=" gallery-item";var j=document.createElement("div");j.className+="row";var k=document.createElement("div");k.innerHTML="<button class='btn btn-xs btn-default pull-right' style='positon:top' title='Edit'><span class='glyphicon glyphicon-pencil'></span></button>",b.firstChild.className+=" col-xs-12",$(k).appendTo($(j)),$(b.firstChild).css("margin-bottom","18px").appendTo($(j)),$(j).appendTo($(b));var l=a.getSourceDataAtRow(c);console.log(l),Handsontable.Dom.addEvent(k,"mousedown",function(a){a.preventDefault(),a.stopPropagation(),f.cbh.openSingleMol(l,!1,e)})}return b},bulletRenderer:function(a,b,c,d,e,f,g){var h="glyphicon glyphicon-unchecked";return"true"==f&&(h="glyphicon glyphicon-check"),b.className="htCenter htMiddle htDimmed",b.innerHTML="<h2 class='blue'><span class='"+h+"'></span></h2>",g.readOnly=!0,b},coverRenderer:function(a,b,c,d,e,h,i){if(null==h||""===h)return b.innerHTML="No Image",b.className+="htCenter htMiddle ",Handsontable.Dom.addEvent(b,"mousedown",function(b){var d=a.getSourceDataAtRow(c);f.cbh.openSingleMol(d,g)}),b;var j;Handsontable.helper.stringify(h);return j=document.createElement("IMG"),j.src="data:image/png;base64,"+h,j.style.cursor="pointer",j.style.width="75px",Handsontable.Dom.addEvent(j,"mousedown",function(b){var d=a.getSourceDataAtRow(c);f.cbh.openSingleMol(d,g)}),Handsontable.Dom.empty(b),b.className+="htCenter htMiddle ",b.appendChild(j),b}};return f=a,i},getColumnLabel:function(a,b){return"<label style='min-width:80px' >"+a.knownBy+"</label>"},renderFilterLink:function(a,b,c){return f(a,b,c)}};return g}]),angular.module("chembiohubAssayApp"),app.directive("dynamic",["$compile",function(a){return{restrict:"A",replace:!0,link:function(b,c,d){b.$watch(d.dynamic,function(d){c.html(d),a(c.contents())(b)})}}}]),angular.module("chembiohubAssayApp").directive("compoundtableheader",function(){return{templateUrl:"views/templates/compound-table-header.html",restrict:"E",link:function(a,b,c){},scope:{compounds:"="}}}),angular.module("chembiohubAssayApp").factory("SkinningFactory",["$resource",function(a){return a(urlConfig.cbh_skinning.list_endpoint,{},{})}]),angular.module("chembiohubAssayApp").factory("AddDataFactory",["$resource","urlConfig",function(a,b){var c=a(b.instance_path.url_frag+"datastore/cbh_datapoint_classifications/:dc",{dc:"@dc"},{update:{method:"PATCH",params:{dc:"@dc"}}}),d=a(b.instance_path.url_frag+"datastore/cbh_datapoint_classifications_nested/:dc",{dc:"@dc"}),e=a(b.instance_path.url_frag+"datastore/cbh_datapoints/:dpid",{dpid:"@dpid"}),f=a(b.instance_path.url_frag+"datastore/cbh_projects_with_forms/");return{dataClassification:c,nestedDataClassification:d,level:e,pwf:f}}]),angular.module("chembiohubAssayApp").controller("AddDataCtrl",["$scope","$stateParams","$resource","AddDataFactory",function(a,b,c,d){a.cbh.appName="AssayReg";var e=this;e.getForm=function(b,e,f){console.log("dc is ",b),console.log("level is ",e);var g;angular.forEach(a.assayctrl.proj.enabled_forms,function(a){a.id==f&&(g=a[e])});var h=!1;a.dc_data={},a.clone={},a.level_datapoint={},a.context_datapoint={},a.test_model={project_data:{}};var i=d.dataClassification,j="",k=i.get({dc:b});k.$promise.then(function(b){a.dc_data=angular.copy(b),a.clone=angular.copy(b),a.clone.resource_uri=null,a.clone[e]="",a.clone.id=null,j=a.dc_data[e];var d="";if("l0"!=e){var f="l"+(parseInt(e[1])+1).toString();d=a.dc_data[f]}if(e)if(h){a.test_level_datapoint}else{var i=c(j,{});if("l0"!=e){var k=c(d,{}),l=k.get();l.$promise.then(function(b){a.context_datapoint=b})}var m=i.get();m.$promise.then(function(b){a.level_datapoint=b,a.level_datapoint.id=null,a.level_datapoint.resource_uri=null,a.custom_field_config=g,a.edit_form=[],a.edit_schema={type:"object",properties:{},required:[]},a.addition_name=a.custom_field_config.name,angular.forEach(a.custom_field_config.project_data_fields,function(b){a.edit_form.push(b.edit_form.form[0]),angular.extend(a.edit_schema.properties,b.edit_schema.properties)})})}})},e.submitForm=function(){a.level_datapoint.project_data=a.test_model.project_data,a.clone[b.lev]=a.level_datapoint,a.clone.$save()},e.clearForm=function(){a.test_model={project_data:{}}},e.getForm(b.dc,b.lev,b.data_form_id)}]),angular.module("chembiohubAssayApp").controller("EditDataCtrl",["$scope","$stateParams","$resource","AddDataFactory",function(a,b,c,d){var e=this;e.getForm=function(b,e){console.log("dc is ",b),console.log("level is ",e);var f=!1;a.dc_data={},a.clone={},a.level_datapoint={},a.test_model={project_data:{}};var g=d.dataClassification,h="",i=g.get({dc:b});i.$promise.then(function(b){if(a.dc_data=angular.copy(b),a.clone=angular.copy(b),console.log(a.clone),a.clone[e]="",h=a.dc_data[e],console.log("level_uri",h),e)if(f){a.test_level_datapoint}else{var d=c(h,{}),g=d.get();g.$promise.then(function(b){a.test_model={project_data:a.level_datapoint.project_data};var d=c(b.custom_field_config,{}),e=d.get();e.$promise.then(function(b){a.custom_field_config=b,a.edit_form=[],a.edit_schema={type:"object",properties:{},required:[]},a.addition_name=a.custom_field_config.name,angular.forEach(a.custom_field_config.project_data_fields,function(b){a.edit_form.push(b.edit_form.form[0]),angular.extend(a.edit_schema.properties,b.edit_schema.properties)})})})}})},e.submitForm=function(){a.level_datapoint.project_data=a.test_model.project_data,a.clone[b.lev]=a.level_datapoint,a.clone.$update({dc:b.dc})},e.clearForm=function(){a.test_model={project_data:{}}},e.getForm(b.dc,b.lev)}]),angular.module("chembiohubAssayApp").controller("ViewDataCtrl",["$scope","ViewDataFactory","$resource","$stateParams","$timeout",function(a,b,c,d,e){var f=this;f.dc=d.dc,c("")}]),angular.module("chembiohubAssayApp").factory("ViewDataFactory",["$resource",function(a){var b={},c={"/test/api/datastore/cbh_datapoints/2":{created:"2015-08-13T09:39:43.650658",created_by:{date_joined:"2015-02-23T10:34:11",first_name:"",id:1,is_staff:!0,is_superuser:!0,last_login:"2015-08-13T04:49:22.465231",last_name:"",resource_uri:"/test/api/users/1",username:"andy"},custom_field_config:"/test/api/datastore/cbh_custom_field_config/106",id:2,modified:"2015-08-13T09:39:43.651076",project_data:{Abstract:"Biiiiiiiiiiiiiiig abstract","Project Id":"ttest"},resource_uri:"/test/api/datastore/cbh_datapoints/2",supplementary_data:{}},"/test/api/datastore/cbh_datapoints/3":{created:"2015-08-13T09:41:43.543643",created_by:{date_joined:"2015-02-23T10:34:11",first_name:"",id:1,is_staff:!0,is_superuser:!0,last_login:"2015-08-13T04:49:22.465231",last_name:"",resource_uri:"/test/api/users/1",username:"andy"},custom_field_config:"/test/api/datastore/cbh_custom_field_config/107",id:3,modified:"2015-08-13T09:41:43.544126",project_data:{Aims:"to test our API","Assays included":"test","Sub-Project ID":"test"},resource_uri:"/test/api/datastore/cbh_datapoints/3",supplementary_data:{}},"/test/api/datastore/cbh_datapoints/4":{created:"2015-08-13T09:42:57.380200",created_by:{date_joined:"2015-02-23T10:34:11",first_name:"",id:1,is_staff:!0,is_superuser:!0,last_login:"2015-08-13T04:49:22.465231",last_name:"",resource_uri:"/test/api/users/1",username:"andy"},custom_field_config:"/test/api/datastore/cbh_custom_field_config/108",id:4,modified:"2015-08-13T09:42:57.381017",project_data:{"Assay ID":"test","Assay Type":"test","Written Protocol":"to test our API"},resource_uri:"/test/api/datastore/cbh_datapoints/4",supplementary_data:{}},"/test/api/datastore/cbh_datapoints/5":{created:"2015-08-13T09:45:10.343853",created_by:{date_joined:"2015-02-23T10:34:11",first_name:"",id:1,is_staff:!0,is_superuser:!0,last_login:"2015-08-13T04:49:22.465231",last_name:"",resource_uri:"/test/api/users/1",username:"andy"},custom_field_config:"/test/api/datastore/cbh_custom_field_config/109",id:5,modified:"2015-08-13T09:46:22.753781",project_data:{"Standard Activity Type":"IC50","Standard Activity Value":"34","Standard Unit":"nM"},resource_uri:"/test/api/datastore/cbh_datapoints/5",supplementary_data:{}},"/test/api/datastore/cbh_datapoints/6":{created:"2015-08-13T09:49:19.760949",created_by:{date_joined:"2015-02-23T10:34:11",first_name:"",id:1,is_staff:!0,is_superuser:!0,last_login:"2015-08-13T04:49:22.465231",last_name:"",resource_uri:"/test/api/users/1",username:"andy"},custom_field_config:"/test/api/datastore/cbh_custom_field_config/109",id:6,modified:"2015-08-13T09:49:19.761362",project_data:{"Standard Activity Type":"IC50","Standard Activity Value":"567","Standard Unit":"nM"},resource_uri:"/test/api/datastore/cbh_datapoints/6",supplementary_data:{}},"/test/api/datastore/cbh_datapoints/7":{created:"2015-08-13T09:49:41.438691",created_by:{date_joined:"2015-02-23T10:34:11",first_name:"",id:1,is_staff:!0,is_superuser:!0,last_login:"2015-08-13T04:49:22.465231",
last_name:"",resource_uri:"/test/api/users/1",username:"andy"},custom_field_config:"/test/api/datastore/cbh_custom_field_config/109",id:7,modified:"2015-08-13T09:49:41.439112",project_data:{"Standard Activity Type":"IC50","Standard Activity Value":"56","Standard Unit":"nM"},resource_uri:"/test/api/datastore/cbh_datapoints/7",supplementary_data:{}},"/test/api/datastore/cbh_datapoints/8":{created:"2015-08-13T09:50:06.390150",created_by:{date_joined:"2015-02-23T10:34:11",first_name:"",id:1,is_staff:!0,is_superuser:!0,last_login:"2015-08-13T04:49:22.465231",last_name:"",resource_uri:"/test/api/users/1",username:"andy"},custom_field_config:"/test/api/datastore/cbh_custom_field_config/109",id:8,modified:"2015-08-13T09:50:06.390549",project_data:{"Standard Activity Type":"IC50","Standard Activity Value":"7","Standard Unit":"nM"},resource_uri:"/test/api/datastore/cbh_datapoints/8",supplementary_data:{}}},d=a("(prefix)/api/datastore/cbh_datapoint_classifications",{});return{dataClassifications:d,test_ws_data:b,test_datapoints:c}}]);var showMappingPopupController=["$scope","$modalInstance","project_fields","sheet","$timeout","$filter","dataoverviewctrl",function(a,b,c,d,e,f,g){a.dataoverviewctrl=g,a.project_fields=angular.copy(c),a.modded_project_fields=[],a.modalInstance=b,a.sheet=d,angular.forEach(a.project_fields,function(b){var c=!1;d.listOfUnmappedFields.indexOf(b.value)>-1&&(a.modded_project_fields.push(b),c=!0),(b.value==g.col_being_mapped.attachment_field_mapped_to||!c&&null==b.value)&&a.modded_project_fields.push(b)}),angular.forEach(a.modded_project_fields,function(b){b.value==g.col_being_mapped.attachment_field_mapped_to&&(a.mapping=b,a.oldRequired=angular.copy(a.mapping.required))}),a.setWarningMessage=function(){angular.forEach(a.modded_project_fields,function(b){a.dataoverviewctrl.col_being_mapped.attachment_field_unmappable_to==b.value&&(a.dataoverviewctrl.col_being_mapped.warningMessage="Attemped to map this field to "+angular.copy(b.name)+" but there are rows with unmappable data. Please correct and re-upload.",a.dataoverviewctrl.col_being_mapped.messageClass="text-danger")})},a.setWarningMessage(),a.cancel=function(){b.dismiss("cancel")},a.someMappingFunction=function(){if(!a.justChanged){if(a.mapping.value){d.listOfUnmappedFields.indexOf(a.mapping.value);d.listOfUnmappedFields.splice(d.listOfUnmappedFields.indexOf(a.mapping.value),1),a.mapping.required&&d.listOfUnmappedMandatoryFields.splice(d.listOfUnmappedMandatoryFields.indexOf(a.mapping.value),1)}g.col_being_mapped.attachment_field_mapped_to!=a.mapping.value&&null!=g.col_being_mapped.attachment_field_mapped_to&&(d.listOfUnmappedFields.push(g.col_being_mapped.attachment_field_mapped_to),a.oldRequired&&d.listOfUnmappedMandatoryFields.push(g.col_being_mapped.attachment_field_mapped_to));var b=(a.mapping.name,angular.copy(a.dataoverviewctrl.col_being_mapped));b.attachment_field_mapped_to=a.mapping.value,b.attachment_field_unmappable_to=null,b.unmappable_rows=[],a.dataoverviewctrl.col_being_mapped.unmappable_rows=[],a.dataoverviewctrl.col_being_mapped.attachment_field_unmappable_to=null,a.oldRequired=angular.copy(a.mapping.required);var c=$http.patch(b.resource_uri,b).then(function(c){if(c.data.attachment_field_unmappable_to){a.setWarningMessage(),null!=b.attachment_field_mapped_to&&(d.listOfUnmappedFields.push(angular.copy(b.attachment_field_mapped_to)),a.mapping.required&&d.listOfUnmappedMandatoryFields.push(angular.copy(b.attachment_field_mapped_to))),a.mapping=a.modded_project_fields[0],d.setNewMapping(c.data);var e=document.getElementById("field-selector");return angular.element(e).blur(),c.data}return a.dataoverviewctrl.col_being_mapped.messageClass="text-success",a.dataoverviewctrl.col_being_mapped.warningMessage="Mapping saved",d.setNewMapping(c.data),c.data},function(a){});return c}},a.clearMapping=function(b){a.mapping=a.modded_project_fields[0],a.someMappingFunction()}}],getSheetsByFile=function(a,b,c,d,e,f,g){c.iamloading=!0,c.loadingMessage="Loading File...";var h=d.cbhFlowfile;a.uploadData.fileId=b;var i=h.get({fileId:b});i.$promise.then(function(b){return-1==i.original_filename.indexOf(".xlsx")?(g.errorPopup("Incorrect file format. Please note only XLSX files are permitted."),void(c.iamloading=!1)):0==b.sheet_names.length?(g.errorPopup("No sheets found in file."),void(c.iamloading=!1)):(angular.forEach(b.sheet_names,function(b){var i={name:b,active:!1};i.listOfUnmappedFields=[],i.listOfUnmappedMandatoryFields=[],i.specifySheet=function(){if(!e&&!angular.isDefined(i.metadata)){c.iamloading=!0,c.loadingMessage="Loading Sheet...";d.cbhAttachments,h.save({flowfile:"/"+f+"/datastore/cbh_flowfiles/"+a.uploadData.fileId,data_point_classification:"/"+f+"/datastore/cbh_datapoint_classifications/"+a.id,chosen_data_form_config:a.next_level_dfc.resource_uri,sheet_name:i.name},function(a){i.active=!0,i.metadata=a,i.listOfUnmappedFields=i.getListOfUnmappedFields(a.attachment_custom_field_config.project_data_fields,a.titleMap),i.listOfUnmappedMandatoryFields=i.getListOfUnmappedMandatoryFields(a.attachment_custom_field_config.project_data_fields,a.titleMap),i.setTotalUnmapped(),c.iamloading=!1})}},i.setTotalUnmapped=function(){i.totalUnmapped=0,i.totalMappingErrors=0,angular.forEach(i.metadata.attachment_custom_field_config.project_data_fields,function(a){a.attachment_field_mapped_to&&i.totalUnmapped++,a.attachment_field_unmappable_to&&i.totalMappingErrors++})},i.setNewMapping=function(a){var b=0;angular.forEach(i.metadata.attachment_custom_field_config.project_data_fields,function(c,d){c.id==a.id&&(b=d)}),i.metadata.attachment_custom_field_config.project_data_fields[b]=a,g.col_being_mapped=a,i.setTotalUnmapped()},i.saveSheet=function(b){c.iamloading=!0,c.loadingMessage="Saving Sheet "+i.name+"...",angular.forEach(a.sheets,function(a){a.specifySheet=null}),$http.get("/"+f+"/datastore/cbh_attachments/save_temporary_data?sheetId="+b).then(function(a){c.iamloading=!1,$state.go($state.current,$stateParams,{reload:!0})})},i.getListOfUnmappedFields=function(a,b){var c=[];return angular.forEach(b,function(b){var d=!1;angular.forEach(a,function(a){a.attachment_field_mapped_to&&(a.attachment_field_mapped_to!=b.value&&b.value||(d=!0))}),d||b.value&&c.push(b.value)}),c},i.getListOfUnmappedMandatoryFields=function(a,b){var c=[];return angular.forEach(b,function(b){var d=!1;angular.forEach(a,function(a){null!=a.attachment_field_mapped_to&&(a.attachment_field_mapped_to!=b.value&&b.value||(d=!0))}),!d&&b.required&&b.value&&c.push(b.value)}),c},a.uploadData.sheets.push(i)}),void(a.uploadData.uploaded=!0))},function(a){g.errorPopup(a.data.error+". Please note only XLSX files are permitted."),c.iamloading=!1})};angular.module("chembiohubAssayApp").controller("DataOverviewCtrl",["$scope","AddDataFactory","$modal","$resource","$stateParams","$state","$timeout","$interval","prefix","urlConfig","$cookies","FlowFileFactory","DraftFactory","projectKey","$filter",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p=this;p.success=function(a,b){var c=l.cbhBaseAttachment,d="";c.save({flowfile:"/"+i+"/datastore/cbh_flowfiles/"+a.uniqueIdentifier,data_point_classification:"/"+i+"/datastore/cbh_datapoint_classifications/"+p.currentlyAddingTo.id},function(c){d=c.resource_uri;var e={url:d,printName:a.name,mimeType:a.file.type};angular.isUndefined(p.currentlyAddingTo.new_next_level_model.project_data[b[0]])&&(p.currentlyAddingTo.new_next_level_model.project_data[b[0]]={attachments:[]}),p.currentlyAddingTo.new_next_level_model.project_data[b[0]].attachments.push(e)})},p.removeFile=function(a,b,c){angular.isUndefined(p.currentlyAddingTo.new_next_level_model.project_data[a[0]])&&(p.currentlyAddingTo.new_next_level_model.project_data[a[0]]={attachments:[]}),p.currentlyAddingTo.new_next_level_model.project_data[a[0]].attachments=o("filter")(p.currentlyAddingTo.new_next_level_model.project_data[a[0]].attachments,function(a,b){return a.url!==c})};var q=!1;a.$on("$destroy",function(){q=!0}),a.cbh.appName="AssayReg";var r={l1:"l1",l2:"l2"};a.iamloading=!1,a.loadingMessage="Loading...",a.modalInstance={},a.popup_data={},a.dpcForUpload={},p.currentlyAddingTo=null,a.getAnnotations=function(c){c.dfc_full=a.assayctrl.dfc_lookup[c.data_form_config],c.main_cfc=c.dfc_full[c.level_from],c.main_data=c[c.level_from],c.htmlClassName=r[c.level_from],c.setChosenDataFormConfig=function(b,d,e){return null!=p.currentlyAddingTo&&d?void p.errorPopup("You are already adding to a different dataset or by a different method. Please cancel that form before continuing."):(d&&(p.currentlyAddingTo=c),c.addingChild=d,c.next_level_dfc=a.assayctrl.dfc_lookup[b],c.next_level_cfc=c.next_level_dfc[c.next_level_dfc.last_level],angular.isDefined(e)?(e.id=null,e.resource_uri=null):e={project_data:{},custom_field_config:c.next_level_cfc.resource_uri},c.default_data=e,c.next_level_edit_form=c.next_level_dfc.get_main_form(),c.next_level_edit_schema=c.next_level_dfc.get_main_schema(),c.new_next_level_model=angular.copy(c.default_data),c.next_data_type_name=c.next_level_dfc[c.next_level_dfc.last_level].data_type.name,void(c.next_level_searchnames=c.next_level_cfc.project_data_fields.map(function(a){return c.next_level_dfc.last_level+".project_data."+a.elasticsearch_fieldname})))},c.setChosenDataFormConfigMultiple=function(b,d,e){return null!=p.currentlyAddingTo&&d?void p.errorPopup("You are already adding to a different dataset or by a different method. Please cancel that form before continuing."):(d&&(p.currentlyAddingTo=c),c.addingMultiple=d,c.next_level_dfc=a.assayctrl.dfc_lookup[b],c.next_level_cfc=c.next_level_dfc[c.next_level_dfc.last_level],angular.isDefined(e)?(e.id=null,e.resource_uri=null):e={project_data:{},custom_field_config:c.next_level_cfc.resource_uri},c.default_data=e,c.next_level_edit_form=c.next_level_dfc.get_main_form(),c.next_level_edit_schema=c.next_level_dfc.get_main_schema(),c.new_next_level_model=angular.copy(c.default_data),c.next_data_type_name=c.next_level_dfc[c.next_level_dfc.last_level].data_type.name,c.inputData={inputstring:""},c.filedata={},c.filesUploading=!1,c.dataReady=!1,c.initUpload=function(){c.uploadData={uploaded:!1,fileId:"",resource_uri:"",sheets:[]}},c.initUpload(),c.cancelFile=function(){c.setChosenDataFormConfigMultiple(b,!1,e),p.currentlyAddingTo=null},c.getSheetsForFile=function(b){getSheetsByFile(c,b,a,l,q,i,p)},void(c.next_level_searchnames=c.next_level_cfc.project_data_fields.map(function(a){return c.next_level_dfc.last_level+".project_data."+a.elasticsearch_fieldname})))},c.cancel=function(){c.dfc_full.permitted_children.length>0&&c.setChosenDataFormConfig(c.dfc_full.permitted_children[0]),c.addingChild=!1,p.currentlyAddingTo=null},c.dfc_full.permitted_children.length>0&&(c.setChosenDataFormConfig(c.dfc_full.permitted_children[0],!1),c.addingChild=!1),c.addDataToForm=function(a){c.addingChild=!0,c.setForm(a)},c.addChild=function(){p.setLoadingMessageHeight(),p.currentlyLoading=!0;var a=b.dataClassification,d=a.get({dc:c.id});d.$promise.then(function(a){a.children=[],a.id=null,a.resource_uri=null,a.parent_id=c.id,a[c.next_level]=c.new_next_level_model,a.data_form_config=c.next_level_dfc.resource_uri,a.$save(function(a){f.go(f.current,e,{reload:!0})})})},c.updateChild=function(a){p.setLoadingMessageHeight(),p.currentlyLoading=!0;var d=b.dataClassification,g=d.get({dc:a});g.$promise.then(function(b){b[c.next_level]=c.new_next_level_model,b.$update({dc:a},function(a){f.go(f.current,e,{reload:!0})})})},c.saveDraft=function(a){console.log("Saving draft");var b=m.save_draft,c=b.get({content:a});c.$promise.then(function(a){console.log("dpc draft saved",a)})},c.next_level_dfc.human_added?c.childrenTemplate="views/templates/overview-children-table.html":c.childrenTemplate="views/templates/overview-children.html",a.dpcForUpload=c},a.iterate_children=function(b){angular.forEach(b.children,function(c,d){angular.isDefined(c.id)&&(c.parentObj=b,a.getAnnotations(c),a.iterate_children(c))})},a.no_l0=!1,p.no_l0_dfc=!1,p.fetchData=function(){b.nestedDataClassification.get({project_key:a.assayctrl.proj.project_key},function(b){b.objects.length>=1?(a.no_l0=!1,p.no_l0_dfc=!1,p.l0_object=b.objects[0],a.getAnnotations(p.l0_object),a.iterate_children(p.l0_object)):(a.no_l0=!0,a.assayctrl.l0_dfc?p.l0_object=angular.copy(a.assayctrl.l0_dfc.template_data_point_classification):p.no_l0_dfc=!0)})},p.openDetail=function(b){a.popup_data=angular.copy(b),a.modalInstance=c.open({templateUrl:"views/modal-template.html",size:"lg",resolve:{popup_data:function(){return a.popup_data}},controller:["$scope","$modalInstance","popup_data","$timeout",function(a,b,c,d){a.popup_data=c,a.modalInstance=b,a.expanded="",a.cancel=function(){b.dismiss("cancel")},a.toggleExpand=function(b){a.expanded==b?a.expanded="":a.expanded=b},a.fetchImage=function(a){return a}}]})},p.errorPopup=function(b){a.popup_data=angular.copy(b),a.modalInstance=c.open({templateUrl:"views/templates/modal-error-template.html",size:"sm",resolve:{popup_data:function(){return a.popup_data}},controller:["$scope","$modalInstance","popup_data","$timeout",function(a,b,c,d){a.popup_data=c,a.modalInstance=b,a.cancel=function(){b.dismiss("cancel")}}]})},p.showMappingPopup=function(b,d,e){a.project_fields=b,p.col_being_mapped=d,a.sheet=e,a.modalInstance=c.open({templateUrl:"views/templates/map-file-modal.html",size:"sm",resolve:{project_fields:function(){return a.project_fields},sheet:function(){return a.sheet},dataoverviewctrl:function(){return p}},controller:showMappingPopupController})},p.openEditDetail=function(d){a.popup_data=angular.copy(d),a.youAreInModal=!0,a.modalInstance=c.open({templateUrl:"views/modal-edit-template.html",size:"lg",resolve:{popup_data:function(){return a.popup_data},youAreInModal:function(){return a.youAreInModal},success:function(){return a.success},removeFile:function(){return a.removeFile}},controller:["$scope","$modalInstance","popup_data","$timeout","youAreInModal","success","removeFile",function(a,c,d,g,h,j,k){a.popup_data=d,a.youAreInModal=h,a.success=j,a.removeFile=k,a.dataoverviewctrl=p,a.popup_data.this_level_edit_form=[],a.popup_data.this_level_edit_schema={type:"object",properties:{},required:[]},angular.forEach(d.main_cfc.project_data_fields,function(b){var c=angular.copy(b.edit_form.form[0]);c.htmlClass="col-xs-12",a.popup_data.this_level_edit_form.push(c),angular.extend(a.popup_data.this_level_edit_schema.properties,angular.copy(b.edit_schema.properties))}),a.success=function(b,c){var d=l.cbhBaseAttachment,e="";d.save({flowfile:"/"+i+"/datastore/cbh_flowfiles/"+b.uniqueIdentifier,data_point_classification:"/"+i+"/datastore/cbh_datapoint_classifications/"+a.popup_data.id},function(d){e=d.resource_uri;var f={url:e,printName:b.name,mimeType:b.file.type};angular.isUndefined(a.popup_data.main_data.project_data[c[0]])&&(a.popup_data.main_data.project_data[c[0]]={attachments:[]}),a.popup_data.main_data.project_data[c[0]].attachments.push(f)})},a.removeFile=function(b,c,d){angular.isUndefined(a.popup_data.main_data.project_data[b[0]])&&(console.log("setting to null"),a.popup_data.main_data.project_data[b[0]]={attachments:[]}),a.popup_data.main_data.project_data[b[0]].attachments=o("filter")(a.popup_data.main_data.project_data[b[0]].attachments,function(a,b){return a.url!==d})},a.modalInstance=c,a.cancel=function(){c.dismiss("cancel")},a.saveEdits=function(){p.setLoadingMessageHeight(),p.currentlyLoading=!0;var d=b.dataClassification,g=d.get({dc:a.popup_data.id});g.$promise.then(function(b){b[a.popup_data.level_from]=a.popup_data.main_data,b.$update({dc:a.popup_data.id},function(a){c.dismiss("saved"),f.go(f.current,e,{reload:!0})})},function(a){})}}]})},a.success=p.success,a.removeFile=p.removeFile,a.csrftoken=k[i.split("/")[0]+"csrftoken"],a.flowinit={target:j.instance_path.url_frag+"flow/upload/",headers:{"X-CSRFToken":a.csrftoken}},p.flowinit=a.flowinit,p.fetchData(),p.setLoadingMessageHeight=function(){var a=$(window).scrollTop();$("#loading-message").css("top",a+200+"px")},p.save_dpc=function(a){p.setLoadingMessageHeight(),p.currentlyLoading=!0;var c=b.dataClassification;c.save(a,function(a){f.go(f.current,e,{reload:!0})},function(a){})},p.tableLoaded=function(a){g(function(){p.initDblScroll(a)},2e3)},p.initDblScroll=function(a){$("#table-"+a).doubleScroll()}}]),angular.module("chembiohubAssayApp").controller("SearchAssaysCtrl",["$scope","$filter","$modal","urlConfig","$stateParams","$state","$location","userList",function(a,b,c,d,e,f,g,h){function i(a,b){if(a===b)return!0;if(null==a||null==b)return!1;if(a.length!=b.length)return!1;for(var c=0;c<a.length;++c)if(a[c]!==b[c])return!1;return!0}a.cbh.appName="AssayReg",a.users=h,a.userData={useruris:[]},a.cbh.textsearch=e.textsearch,a.$watch(function(a){return a.cbh.textsearch},function(a){e.textsearch=a,f.params.textsearch=a,g.search("textsearch",a)}),a.selections={l0:[],l1:[],l2:[]},e.l0&&(a.selections.l0=decodeURIComponent(e.l0).split(",")),e.l1&&(a.selections.l1=decodeURIComponent(e.l1).split(",")),e.l2&&(a.selections.l2=decodeURIComponent(e.l2).split(",")),e.useruris&&(a.userData.useruris=decodeURIComponent(e.useruris).split(",")),a.dates={start:"",end:"",startES:"",endES:""},a.modalInstance={},a.popup_data={},a.indexVMOnInit=[],a.$watch(function(a){return a.selections.l0},function(a,b){i(a,b)||(e.l0=a,f.params.l0=a,g.search("l0",a.join()))},!0),a.$watch(function(a){return a.selections.l1},function(a,b){i(a,b)||(e.l1=a,f.params.l1=a,g.search("l1",a.join()))},!0),a.$watch(function(a){return a.selections.l2},function(a,b){i(a,b)||(e.l2=a,f.params.l2=a,g.search("l2",a.join()))},!0),a.$watch(function(a){return a.userData.useruris},function(a,b){i(a,b)||(e.useruris=a,f.params.useruris=a,g.search("useruris",a.join()))},!0),a.searchFieldsCount=0,a.advancedSearchFields=[],a.addCustomField=function(){var b=a.searchFieldsCount+1;a.advancedSearchFields.push({name:"",value:"",id:b,newItemNo:b}),a.searchFieldsCount++},a.removeCustomField=function(b){var c=a.advancedSearchFields.indexOf(b);a.advancedSearchFields.splice(c,1)},a.selectedUris=function(b){return a.selections[b]},a.isSelectedInUrl=function(b,c){return angular.forEach(a.selections[b],function(a){return console.log(b),a==c?!0:void 0}),!1},a.clearSelections=function(b){a.selections[b]=[]},a.clearUserSelections=function(){a.userData.useruris=[]},a.dateHandler=function(c){var d=a.dates[c];if(""!=d){var h=new Date(d);a.dates[c+"ES"]=b("date")(h,"yyyy-MM-dd")}else a.dates[c+"ES"]="";e[c]=d,f.params[c]=d,g.search(c,d)},angular.forEach(["start","end"],function(b){e[b]&&(a.dates[b]=e[b],a.dateHandler(b))}),a.resetForm=function(){f.go("cbh.search_assays",{l0:void 0,l1:void 0,l2:void 0,start:void 0,textsearch:void 0,end:void 0})},a.showChemblPopup=function(b){a.popup_data=b,a.modalInstance=c.open({templateUrl:"views/modal-template.html",size:"lg",resolve:{popup_data:function(){return a.popup_data}},controller:["$scope","$modalInstance","popup_data","$timeout",function(a,b,c,d){a.popup_data=c,a.popup_data.main_cfc="chembl",a.modalInstance=b,a.cancel=function(){b.dismiss("cancel")}}]})},a.showDetailPopup=function(b,d){$http.get(b).then(function(b){a.popup_data={},a.popup_data.main_cfc=b.data,a.popup_data.main_data={},a.popup_data.main_data.project_data=d,a.modalInstance=c.open({templateUrl:"views/modal-template.html",size:"lg",resolve:{popup_data:function(){return a.popup_data}},controller:["$scope","$modalInstance","popup_data","$timeout",function(a,b,c,d){a.popup_data=c,a.modalInstance=b,a.cancel=function(){b.dismiss("cancel")}}]})})},a.isHighlightPresent=function(a,b){return angular.forEach(a,function(a,c){return 0==c.indexOf(b)?a:void 0}),!1}}]),angular.module("chembiohubAssayApp").factory("FlowFileFactory",["$resource","urlConfig",function(a,b){var c=a(b.instance_path.url_frag+"datastore/cbh_flowfiles/:fileId",{fileId:"@fileId"}),d=a(b.instance_path.url_frag+"datastore/cbh_attachments",{flowfile:b.instance_path.url_frag+"datastore/cbh_flowfiles/@flowfile",data_point_classification:"@data_point_classification",chosen_data_form_config:"@chosen_data_form_config",sheet_name:"@sheetname"}),e=a(b.instance_path.url_frag+"datastore/cbh_base_attachments",{flowfile:b.instance_path.url_frag+"datastore/cbh_flowfiles/@flowfile",data_point_classification:"@data_point_classification"}),f=a(b.instance_path.url_frag+"datastore/cbh_attachments/save_temporary_data/",{sheetId:"@sheetId"});return{cbhFlowfile:c,cbhAttachments:d,cbhSaveAttachment:f,cbhBaseAttachment:e}}]),angular.module("chembiohubAssayApp").factory("InvitationFactory",["$resource","urlConfig",function(a,b){var c=a(b.invitations.list_endpoint,NaN);return{invite:c}}]),angular.module("chembiohubAssayApp").controller("AddSingleCompoundCtrl",["$scope","$rootScope","$timeout","$filter","$state","$stateParams","CBHCompoundBatch","ProjectFactory","MessageFactory","mol","projectList",function(a,b,c,d,e,f,g,h,i,j,k){var l=f.projectKey;a.clonedMol=angular.copy(j),a.mol=angular.copy(j),a.mol.molecule=a.mol.ctab,a.mol.id=null,a.clonedMol.id?a.idToClone=a.clonedMol.id:a.idToClone=null,a.editMode=!1,a.revert=function(){a.mol=angular.copy(a.clonedMol),a.mol.molecule=a.mol.ctab,a.mol.id=null,b.$broadcast("setMolecule")},a.dataReady=!1,a.compoundBatches={data:[],sorts:[],excluded:[],redraw:0,columns:[]};var m=d("orderBy"),n=l;a.projectWithCustomFieldData,angular.forEach(k.objects,function(b){b.project_key===n&&(a.projectWithCustomFieldData=b,a.projectWithCustomFieldData.updateCustomFields(),a.projectObj=b)});var o=a.projectWithCustomFieldData.schemaform.form;Math.ceil(o.length/2);a.myform=angular.copy(o),a.$on("moleculeChanged",function(){a.dataReady=!1,a.dataset=void 0}),a.createMultiBatch=function(){a.currentlyLoading=!0,g.createMultiBatch(a.dataset).then(function(b){a.currentlyLoading=!1,a.filesInProcessing=!1,a.dataset.config=b.data,a.dataReady=!0,a.compoundBatches.data=b.data.objects,a.compoundBatches.savestats=b.data.savestats},function(b){a.dataset.config.errors=[i.getMessage("data_not_processed")],a.dataset.config.status="add",a.dataReady=!1,a.currentlyLoading=!1})},a.removeAlert=function(){a.update_success=!1},a.validateDrawn=function(){var b={multiplebatch:null,sketch:a.mol.molecule,type:"sketch",customFields:a.mol.customFields,supplementaryFields:a.mol.supplementaryFields,projectKey:l,struccol:"",state:"validate"};a.dataset={config:b,cancellers:[]},a.createMultiBatch()},a.saveTemporaryCompoundData=function(b){a.currentlyLoading=!0;var c=function(){e.transitionTo("cbh.search",{multiple_batch_id:a.dataset.config.multiplebatch,projectFrom:l,project__project_key__in:l},{location:!0,inherit:!1,relative:null,notify:!0})};g.saveMultiBatchMolecules(a.dataset.config).then(function(d){a.cbh.hideSearchForm=!0,a.idToClone&&b?(a.clonedMol.properties.archived="true",a.clonedMol.projectKey=a.projectWithCustomFieldData.project_key,g.patch(a.clonedMol).then(function(a){g.reindexModifiedCompound(a.id).then(function(a){c()})},function(b){a.currentlyLoading=!1})):c()},function(b){a.currentlyLoading=!1})},a.addSupplementaryField=function(){a.mol.supplementaryFields.length>0?(a.mol.supplementaryFields=m(a.mol.supplementaryFields,"id"),angular.forEach(a.mol.supplementaryFields,function(b,c){if(console.log("supfield",b),console.log("index",c),c==a.mol.supplementaryFields.length-1){var d=b.id+1;console.log(d),a.mol.supplementaryFields.push({id:d,name:"",value:""})}})):a.mol.supplementaryFields.push({id:0,name:"",value:""})},a.removeSupplemetaryField=function(b){console.log(b);var c=d("filter")(a.mol.supplementaryFields,{id:b},!0);a.mol.supplementaryFields.splice(a.mol.supplementaryFields.indexOf(c[0]),1)},a.myschema=a.projectWithCustomFieldData.schemaform.schema}]),angular.module("chembiohubAssayApp").factory("ProjectTypeFactory",["$resource","urlConfig",function(a,b){return a(b.cbh_project_types.list_endpoint+"/:projectTypeId",{projectTypeId:"@projectTypeId"},{update:{method:"PATCH"}})}]),angular.module("chembiohubAssayApp").factory("DraftFactory",["$resource","urlConfig",function(a,b){var c=a(b.instance_path.url_frag+"datastore/cbh_datapoint_classifications/save_draft/",{content:"@content"}),d=a(b.instance_path.url_frag+"datastore/cbh_datapoint_classifications/get_draft/",{draft_key:"@draft_key"}),e=a(b.instance_path.url_frag+"datastore/cbh_datapoint_classifications/get_draft_list/");return{save_draft:c,get_draft:d,list:e}}]),angular.module("chembiohubAssayApp").controller("ProjectlistCtrl",["$rootScope","$state","$stateParams","$scope","AddDataFactory","$modal","$timeout","ProjectFactory","ProjectTypeFactory","Projectpermissions","userList","urlConfig","loggedInUser","ProjectPermissionAllRoles",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){d.default_project_type="",d.links=[];var o=function(){i.get({saved_search_project_type:!1},function(a){d.projectTypes=a.objects.map(function(a){return a.set_as_default&&(d.default_project_type=a),{name:a.name,value:a}})})};d.loadSavedSearches=function(){var a={creator_uri:m.resource_uri};$http.get(l.cbh_saved_search.list_endpoint+"/get_list_elasticsearch/",{params:a}).then(function(a){d.links=a.data.objects,console.log(d.links),d.$apply()})},o(),d.loadSavedSearches(),d.openProjectWindow=function(a){d.projectId=a,d.modalInstance=f.open({templateUrl:"views/modal-edit-project.html",size:"lg",resolve:{projectId:function(){return d.projectId},default_project_type:function(){return d.default_project_type},projectTypes:function(){return d.projectTypes}},controller:"ProjectfieldsCtrl"})},d.openEditPermissions=function(a){d.projectId=a.id,d.proj=a,d.modalInstance=f.open({templateUrl:"views/modal-edit-project-permissions.html",size:"md",resolve:{proj:function(){return d.proj},permissions:function(){return n.get_for_project(d.projectId)}},controller:"ProjectpermissionsCtrl"})},d.cbh.appName="Platform",a.headline=d.cbh.skinning.project_alias+" List",a.subheading="A list of all of the projects you have access to.",a.help_lookup="",a.projectKey=d.cbh.skinning.project_alias+"s",a.projName=d.cbh.skinning.project_alias+"s",a.glyphicon="folder-open",d.isDefault=!0,d.toggleDataSummary={showFlag:!1},d.toggleSingleForm={showFlag:!1},d.cbh.searchForUserWithProjectKey=function(a){e.nestedDataClassification.get({project_key:a},function(a){a.objects.length>=1?b.go("cbh.search_assays",{useruris:[d.cbh.logged_in_user.resource_uri],l0:[a.objects[0].l0.resource_uri]}):b.go("cbh.search_assays",{useruris:[d.cbh.logged_in_user.resource_uri]})})}}]),angular.module("chembiohubAssayApp").controller("CbhCtrl",["$scope","$rootScope","$state","$location","$modal","urlConfig","loggedInUser","projectList","prefix","$compile","MessageFactory","skinConfig","InvitationFactory",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this;n.isIE=detectIE(),n.appName="Platform",n.logged_in_user=g,n.projects=h,n.skinning=l.objects[0],n.prefix=f.instance_path.base,n.api_base=f.admin.list_endpoint,n.searchPage=function(){c.go("cbh.search",{},{reload:!0})},n.textsearch="",a.projects=h.objects,b.projects=h.objects,a.projects.map(function(b){b.is_default||(a.isDefault=!1)}),angular.element(document).ready(function(){angular.element("info-box",function(){})}),a.isLoggedIn=function(){var a=!1;return n.logged_in_user.id>0&&(a=!0),a},b.getUrlBase=function(){return f.instance_path.url_frag},a.getProjectObj=function(b){angular.forEach(a.projects,function(a){return b==a.project_key?a:void 0})},n.messages=k.getMessages(),n.createCustomFieldTransport=function(a,b,c){var d,e="",f=[];if(angular.forEach(a,function(a){angular.isObject(a)&&(a=angular.fromJson(angular.toJson(a))),f.push(a)}),angular.isDefined(a)&&angular.isDefined(b)){if(a.length>b.length){if(e="add","obj"==c)var d=_.filter(f,function(a){return!_.findWhere(b,a)});else if("string"==c)var d=_.difference(f,b)}else if(b.length>a.length)if(e="remove","obj"==c)var d=_.filter(b,function(a){return!_.findWhere(f,a)});else if("string"==c)var d=_.difference(b,f);return{newValue:d[0],addOrRemove:e}}},n.openFilterPopup=function(b){console.log("col",b),a.col=angular.copy(b),a.modalInstance=e.open({templateUrl:"views/templates/compound-table-filter.html",size:"md",resolve:{col:function(){return a.col}},controller:["$scope","$modalInstance","col","$timeout",function(a,b,c,d){a.col=c,a.modalInstance=b,a.cancel=function(){b.dismiss("cancel")}}]})},n.openSingleMol=function(d,f,g){var h=g?"views/templates/single-field.html":"views/templates/single-compound-full.html",i=g?"editing":"";a.modalInstance=e.open({templateUrl:h,size:"lg",windowClass:i,controller:["$scope","$rootScope","$modalInstance","$timeout","CBHCompoundBatch","ProjectFactory",function(a,b,e,h,i,j){a.isNewCompoundsInterface=f,a.editMode=!1,a.mol=angular.copy(d);var k=d.project.split("/"),l=k[k.length-1];a.projectWithCustomFieldData,angular.forEach(b.projects,function(b){b.id.toString()==l&&(a.projectWithCustomFieldData=b,a.projectWithCustomFieldData.updateCustomFields(),a.projectObj=b)}),a.openClone=function(){e.dismiss("cancel"),a.projectObj.project_type.show_compounds?c.go("cbh.projects.project.addsingle",{projectKey:a.projectObj.project_key,idToClone:a.mol.id},{reload:!0}):b.$broadcast("cloneAnItem",d)},a.singleForm=!1,g&&angular.forEach(a.projectWithCustomFieldData.schemaform.form,function(b){b.key===g.split(".")[1]&&(a.singleForm=[angular.copy(b)])});var m=a.projectWithCustomFieldData.schemaform.form,o=Math.ceil(m.length/2);a.firstForm=angular.copy(m).splice(0,o),a.secondForm=angular.copy(m).splice(o),a.myform2=angular.copy(m),a.init=function(){a.keyValues=a.myform2.map(function(b){var c=b;angular.isDefined(b.key)&&(c=b.key);var d="";return angular.isDefined(a.mol.customFields[c])&&(d=a.mol.customFields[c]),d.constructor===Array&&(d=d.join(", ")),{key:c,value:d}}),a.firstList=a.keyValues.splice(0,o),a.secondList=a.keyValues},a.init(),a.removeAlert=function(){a.update_success=!1},n.isUpdated=!1,a.updateBatch=function(b){i.patch({customFields:a.mol.customFields,projectKey:a.projectWithCustomFieldData.project_key,id:a.mol.id}).then(function(c){a.mol.customFields=c.customFields,d.customFields=c.customFields,i.reindexModifiedCompound(a.mol.id).then(function(a){}),a.update_success=!0,a.editMode=!1,a.init(),h(a.removeAlert,5e3),n.isUpdated=!0,angular.isDefined(b)&&b.dismiss("cancel")})},a.myschema=a.projectWithCustomFieldData.schemaform.schema,a.modalInstance=e}]}).result["finally"](function(){n.isUpdated&&b.$broadcast("updateListView")})},n.errorPopup=function(b){a.popup_data=angular.copy(b),a.modalInstance=e.open({templateUrl:"views/templates/modal-error-template.html",size:"sm",resolve:{popup_data:function(){return a.popup_data}},controller:["$scope","$modalInstance","popup_data","$timeout",function(a,b,c,d){a.popup_data=c,a.modalInstance=b,a.cancel=function(){b.dismiss("cancel")}}]})},n.invitationPopup=function(){a.modalInstance=e.open({templateUrl:"views/templates/modal-invitation-template.html",size:"md",controller:["$scope","$modalInstance","InvitationFactory",function(a,b,c){a.clearForm=function(){a.invite={firstName:"",lastName:"",email:"",projects_selected:[],remind:!1},a.validationMessage=""},a.modalInstance=b,a.clearForm(),a.setWatcher=function(){a.watch=a.$watch("invite.email",function(b,c){b!=c&&(a.invite.remind=!1)})},a.setWatcher(),a.projects=[],angular.forEach(n.projects.objects,function(b){b.editor&&a.projects.push(b)}),a.cancel=function(){a.validationMessage="",b.dismiss("cancel")},a.sendInvite=function(){a.validationMessage="",""==a.invite.email?a.validationMessage="Please enter an email address so we can send the invitation.":0==a.invite.projects_selected.length?a.validationMessage="Please select at least one project to add this user to.":c.invite.save(a.invite,function(b){a.watch(),a.invite.email="",a.invite.remind=!1,a.validationMessage=b.message,$timeout(function(){a.setWatcher()},100)},function(b){409==b.status?(a.validationMessage=b.data.error,a.invite.remind=!0):(a.validationMessage="There was a problem sending your invitation, please contact the ChemBio Hub team.",b.data&&b.data.error&&(a.validationMessage=b.data.error))})}}]})},n.currentPageClass=function(a){return c.includes(a)?"current-page":""}}]),angular.module("chembiohubAssayApp").controller("ProjectfieldsCtrl",["$scope","$modalInstance","$rootScope","ProjectFactory","projectId","default_project_type","projectTypes",function(a,b,c,d,e,f,g){
a.isIE=detectIE();var h=[{name:"Short text",value:"char"},{name:"Full text",value:"textarea"},{name:"Choice",value:"uiselect"},{name:"Integer field",value:"integer"},{name:"Decimal field",value:"number"},{name:"Choice allowing create",value:"uiselecttag"},{name:"Tags field allowing create",value:"uiselecttags"},{name:"Percentage field",value:"percentage"},{name:"Date Field",value:"date"},{name:"Link to server or external",value:"href"},{name:"Image link to embed",value:"imghref"},{name:"Decimal field",value:"decimal"},{name:"checkbox",value:"boolean"}],i=[{value:"open",name:"Open"},{value:"restricted",name:"Restricted to editors"}],j=function(){a.projectForm=[{key:"name",htmlClass:"col-sm-5",disableSuccessState:!0,title:"Project Name",required:!0,feedback:!1,onChange:function(b,c){a.proj.custom_field_config.name=a.proj.name+"__config"}},{key:"project_type",title:"Project Type",type:"radiobuttons",titleMap:g,htmlClass:"col-sm-5",disableSuccessState:!0,feedback:!1},{key:"custom_field_config.project_data_fields",title:"Project Data Fields",type:"array",description:"Fields that will be displayed for this project. Drag a field to change the order it is displayed in. The order of existing fields can be changed but they cannot be removed or renamed.",items:[{type:"section",htmlClass:"row",items:[{key:"custom_field_config.project_data_fields[].name",htmlClass:"col-sm-2",disableSuccessState:!0,feedback:!1,title:"Name",required:!0,isReadOnly:function(b){var c=!1,d=a.proj;return angular.forEach(b.slice(0,-1),function(a){d=d[a]}),d.id&&(c=!0),c}},{title:"Required",type:"select",disableSuccessState:!0,key:"custom_field_config.project_data_fields[].required","default":!1,titleMap:[{value:!0,name:"Yes"},{value:!1,name:"No"}],htmlClass:"col-sm-2"},{title:"Field Type",key:"custom_field_config.project_data_fields[].field_type",titleMap:h,disableSuccessState:!0,type:"select",htmlClass:"col-sm-2"},{title:"Description",key:"custom_field_config.project_data_fields[].description",htmlClass:"col-sm-2",disableSuccessState:!0,feedback:!1},{title:"Visibility",key:"custom_field_config.project_data_fields[].open_or_restricted",titleMap:i,disableSuccessState:!0,type:"select",htmlClass:"col-sm-3"}]},{type:"section",htmlClass:"row",items:[{htmlClass:"col-sm-6",key:"custom_field_config.project_data_fields[].default",title:"Default Value",disableSuccessState:!0,feedback:!1,condition:"model.custom_field_config.project_data_fields[arrayIndex].required"},{htmlClass:"col-sm-6",key:"custom_field_config.project_data_fields[].allowed_values",disableSuccessState:!0,feedback:!1,title:"Allowed values (comma-separated)",condition:"(model.custom_field_config.project_data_fields[arrayIndex].field_type == 'uiselect' || model.custom_field_config.project_data_fields[arrayIndex].field_type == 'uiselecttags' || model.custom_field_config.project_data_fields[arrayIndex].field_type == 'uiselecttag')"}]}],htmlClass:"col-sm-12"}],a.projectSchema={type:"object",properties:{name:{title:"Project Name",type:"string",pattern:"^[a-zA-Z0-9_ /&]*$",validationMessage:{202:"Only letters, spaces, numbers, dashes, slashes, & signs and underscores in project names"}},project_type:{title:"Project Type",type:"object","enum":g.map(function(a){return a.value}),"default":f},custom_field_config:{type:"object",properties:{project_data_fields:{type:"array",items:{type:"object",properties:{name:{type:"string","default":"",pattern:"^[^./\"',]*$",validationMessage:{202:"Dots, commas, quotes and slashes not permitted in field names"}},description:{type:"string"},required:{type:"boolean","default":!1},field_type:{type:"string","default":"char","enum":h.map(function(a){return a.value})},open_or_restricted:{type:"string","enum":i.map(function(a){return a.value}),"default":"open"},allowed_values:{type:"string","default":""},"default":{type:"string","default":""}}}}}}}}};a.modalInstance=b,a.setProjectType=function(){g.forEach(function(b){b.value.id==a.proj.project_type.id&&(a.proj.project_type=b.value)})},-1==e?(a.operation="add",a.proj={project_type:f,custom_field_config:{project_data_fields:[{required:!1,field_type:"char",open_or_restricted:"open"}]}},j()):d.get({projectId:e},function(b){a.operation="update",a.proj=b,a.setProjectType(),j()}),a.copyProjectDefinition=function(b){d.get({projectId:b},function(b){a.proj.project_type=b.project_type,a.setProjectType(),1==a.proj.custom_field_config.project_data_fields.length&&(""===a.proj.custom_field_config.project_data_fields[0].name||angular.isUndefined(a.proj.custom_field_config.project_data_fields[0].name))&&(a.proj.custom_field_config.project_data_fields=[]),angular.forEach(b.custom_field_config.project_data_fields,function(b){b.id=void 0,b.resource_uri=void 0,b.pk=void 0,a.proj.custom_field_config.project_data_fields.push(b)})})},a.cancel=function(){b.dismiss("cancel")},a.errormess="";var k=function(){var b={},c=[];angular.forEach(a.proj.custom_field_config.project_data_fields,function(a,d){angular.isUndefined(a.name)&&(a.name=""),a.name&&(angular.isUndefined(b[a.name])?b[a.name]=[d]:(b[a.name].push(d),c.push(a.name)))}),c.length>0&&(a.errormess="Duplicate names found:   "+c.join(", "))};a.saveChanges=function(c){if(a.$broadcast("schemaFormValidate"),a.errormess="",c.$valid){var e=function(a){b.dismiss("cancel"),location.reload(!0)};k(),a.errormess?console.log(c):(a.operation="add")?d.save(a.proj,e):d.update({projectId:a.proj.id},a.proj,e)}else a.errormess="Please correct the errors above in order to save this project."}}]),angular.module("chembiohubAssayApp").controller("ProjectpermissionsCtrl",["$scope","$q","$modalInstance","$rootScope","Projectpermissions","proj","permissions","userList","ProjectPermissionAllRoles",function(a,b,c,d,e,f,g,h,i){a.projectPermissions=g,a.allUsers=angular.copy(h),a.proj=f,a.saveChanges=function(){var b={objects:a.projectPermissions.roles.map(function(b){return a.projectPermissions[b]})};e.update({},b,function(b){location.reload(!0),a.cancel()})},a.cancel=function(){c.dismiss("cancel")},a.copyProjectPermissions=function(b){i.get_for_project(b,a.projectPermissions)}}]),angular.module("chembiohubAssayApp").factory("Projectpermissions",["$resource","urlConfig",function(a,b){return a(b.cbh_permissions.list_endpoint+"/:codename",{codename:"@codename"},{update:{method:"PATCH"}})}]),angular.module("chembiohubAssayApp").factory("ProjectPermissionAllRoles",["$timeout","Projectpermissions",function(a,b){return{get_for_project:function(c,d){var e={roles:["owner","editor","viewer"]};return angular.forEach(e.roles,function(f){e[f]=b.get({codename:c+"__"+f},function(b){if(angular.isDefined(d)){var c=0;angular.forEach(b.users,function(a){-1==d[f].users.indexOf(a)&&(d[f].users.push(a),c++)});var e;switch(c){case 0:e="No users were copied as "+f+"s.";break;case 1:if(-1!=["a","e","i","o","u"].indexOf(f.slice(0,1))){e="1 user was copied as an "+f+".";break}e="1 user was copied as a "+f+".";break;default:e=c+" users were copied as "+f+"s."}d[f+"_message"]=e,a(function(){d[f+"_message"]=""},1e4)}}),e[f+"_user_tagfunction"]=function(a){return{username:a,external:!0,first_name:"",last_name:"",email:a,inviting:!0,resource_uri:a}}}),e}}}]),angular.module("chembiohubAssayApp").factory("SavedSearchFactory",["$resource","urlConfig",function(a,b){var c=a(b.cbh_saved_search.list_endpoint,{},{}),d=a(b.cbh_saved_search.list_endpoint+"/get_list_elasticsearch/",{creator_uri:"@creator_uri"},{}),e=a(b.cbh_saved_search.list_endpoint+"/reindex_compound",{},{});return{list:c,list_es:d,reindex:e}}]);